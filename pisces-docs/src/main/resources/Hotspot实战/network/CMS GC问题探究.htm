
<!DOCTYPE html>
<!-- saved from url=(0172)file:///Users/mondge/xujun/workspace/pisces/pisces-docs/src/main/resources/Hotspot%E5%AE%9E%E6%88%98/network/CMS%20GC%E9%97%AE%E9%A2%98%E6%8E%A2%E7%A9%B6.htm#CMSGC????-???? -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>CMS GC问题探究</title>
    <script type="text/javascript">
        var contextPath = '';
    </script>
    <link type="text/css" rel="stylesheet" href="./CMS GC问题探究_files/batch.css" data-wrm-key="_super" data-wrm-batch-type="context" media="all">
    <link type="text/css" rel="stylesheet" href="./CMS GC问题探究_files/batch(1).css" data-wrm-key="atl.confluence.plugins.pagetree-desktop,main,viewcontent,page,atl.general,atl.comments,-_super" data-wrm-batch-type="context" media="all">
    <link type="text/css" rel="stylesheet" href="./CMS GC问题探究_files/batch(2).css" media="print" data-wrm-key="atl.confluence.plugins.pagetree-desktop,main,viewcontent,page,atl.general,atl.comments,-_super" data-wrm-batch-type="context">
</head>
<body id="com-atlassian-confluence" class="theme-default  aui-layout aui-theme-default" data-aui-version="5.9.22">
<div id="page">
    <div id="full-height-container">
        <div id="header-precursor">
            <div class="cell">

            </div>
        </div>
        <div class="ia-splitter">
            <div class="ia-splitter-left">

            </div>
            <!-- \#header -->



            <div id="main" class=" aui-page-panel" style="margin-left: 55px;">
                <div id="main-header" class="" style="top: 41px; width: 1145px;">

                    <div id="navigation" class="content-navigation view">
                        <ul class="ajs-menu-bar">
                            <li class="ajs-button normal">







                            </li>
                            <li class="ajs-button normal">







                            </li>
                            <li class="ajs-button normal">







                            </li>
                            <li class="ajs-button normal">







                            </li>

                            <li class="normal ajs-menu-item">
                                <div id="action-menu" class="aui-dropdown2 aui-style-default aui-layer most-right-menu-item" aria-hidden="true" resolved="">
                                    <div class="aui-dropdown2-section">
                                        <ul id="action-menu-primary" class="section-primary first">
                                            <li>






                                                <a id="view-attachments-link" href="https://wiki.sankuai.com/pages/viewpageattachments.action?pageId=1079095662" rel="nofollow" class="action-view-attachments" accesskey="t" title="查看附件 (t)">
                <span>
                        <u>t</u>附件(13)
        </span>    </a>
                                            </li>
                                            <li>






                                                <a id="action-view-history-link" href="https://wiki.sankuai.com/pages/viewpreviousversions.action?pageId=1079095662" rel="nofollow" class="action-view-history" title="">
                <span>
                        页面历史
        </span>    </a>
                                            </li>
                                            <li>






                                                <a id="action-page-permissions-link" href="https://wiki.sankuai.com/pages/viewinfo.action?pageId=1079095662" rel="nofollow" class="action-page-permissions" title="编辑限制">
                <span>
                        限制
        </span>    </a>
                                            </li>
                                        </ul>
                                    </div>
                                    <div class="aui-dropdown2-section">
                                        <ul id="action-menu-secondary" class="section-secondary">
                                            <li>






                                                <a id="view-page-info-link" href="https://wiki.sankuai.com/pages/viewinfo.action?pageId=1079095662" rel="nofollow" class="action-view-info" title="">
                <span>
                        页面信息
        </span>    </a>
                                            </li>
                                            <li>






                                                <a id="view-resolved-comments" href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" rel="nofollow" class="" title="">
                                                    <span>已解决评论 (0)</span>    </a>
                                            </li>
                                            <li>






                                                <a id="link-to-page-link" href="https://wiki.sankuai.com/pages/viewinfo.action?pageId=1079095662" rel="nofollow" class="" title="链接至本页面 (k)">
                <span>
                        链接到此页…
        </span>    </a>
                                            </li>
                                            <li>






                                                <a id="view-in-hierarchy-link" href="https://wiki.sankuai.com/pages/reorderpages.action?key=YHYX&amp;openId=1079095662#selectedPageInHierarchy" rel="nofollow" class="" title="">
                <span>
                        以层级方式查看
        </span>    </a>
                                            </li>
                                            <li>






                                                <a id="action-source-editor-view-storage-link" href="https://wiki.sankuai.com/plugins/viewstorage/viewpagestorage.action?pageId=1079095662" rel="nofollow" class="action-view-storage view-storage-link popup-link" title="">
                <span>
                        View Storage Format
        </span>    </a>
                                            </li>
                                            <li>






                                                <a id="action-view-source-link" href="https://wiki.sankuai.com/plugins/viewsource/viewpagesrc.action?pageId=1079095662" rel="nofollow" class="action-view-source popup-link" title="">
                <span>
                        查看页面源代码
        </span>    </a>
                                            </li>
                                            <li>






                                                <a id="action-export-word-link" href="https://wiki.sankuai.com/exportword?pageId=1079095662" rel="nofollow" class="action-export-word" title="">
                <span>
                        导出为Word
        </span>    </a>
                                            </li>
                                            <li>






                                                <a id="import-word-doc" href="https://wiki.sankuai.com/pages/worddav/uploadimport.action?pageId=1079095662" rel="nofollow" class="" title="">
                <span>
                        Doc文件导入
        </span>    </a>
                                            </li>
                                        </ul>
                                    </div>
                                    <div class="aui-dropdown2-section">
                                        <ul id="action-menu-modify" class="section-modify">
                                            <li>






                                                <a id="action-copy-page-link" href="https://wiki.sankuai.com/pages/copypage.action?idOfPageToCopy=1079095662&amp;spaceKey=YHYX" rel="nofollow" class="action-copy" title="">
                <span>
                        复制
        </span>    </a>
                                            </li>
                                            <li>






                                                <a id="action-move-page-dialog-link" href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662" rel="nofollow" class="action-move" title="">
                <span>
                        移动
        </span>    </a>
                                            </li>
                                            <li>






                                                <a id="action-remove-content-link" href="https://wiki.sankuai.com/pages/removepage.action?pageId=1079095662" rel="nofollow" class="action-remove" title="">
                <span>
                        删除
        </span>    </a>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </li>
                        </ul>
                    </div>


                    <div id="title-heading" class="pagetitle with-breadcrumbs">

                        <div id="breadcrumb-section">



                            <ol id="breadcrumbs">





                                <li class="hidden-crumb">

                                    <span class=""><a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=452302306">新垂直业务研发组</a></span>


                                </li><li class="hidden-crumb">

                                <span class=""><a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1052761851">08.新垂直分享</a></span>


                            </li></ol>


                        </div>


                        <a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#page-banner-end" class="assistive">跳到banner的尾部</a>
                        <div id="page-banner-start" class="assistive"></div>


                        <div id="page-metadata-banner" style="visibility: visible;"><ul class="banner"></ul></div>


                        <a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#page-banner-start" class="assistive">回到标题开始</a>
                        <div id="page-banner-end" class="assistive"></div>


                        <h1 id="title-text" class="with-breadcrumbs" style="display: block;">
                            <a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662">CMS GC问题探究</a>
                        </h1>
                    </div>
                </div><!-- \#main-header -->



                <div id="sidebar-container">
                </div><!-- \#sidebar-container -->







































                <div id="content" class="page view">
                    <div id="main-content" class="wiki-content">

                        <h1 id="CMSGC问题探究-"><div class="toc-macro client-side-toc-macro  conf-macro output-block hidden-outline" data-headerelements="H1,H2,H3,H4,H5,H6,H7" data-hasbody="false" data-macro-name="toc"><ul style=""><li><span class="toc-item-body" data-outline="2"><span class="toc-outline">2</span><a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#CMSGC问题探究-一、现象" class="toc-link">一、现象</a></span></li><li><span class="toc-item-body" data-outline="3"><span class="toc-outline">3</span><a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#CMSGC问题探究-二、过程" class="toc-link">二、过程</a></span><ul style=""><li><span class="toc-item-body" data-outline="3.1"><span class="toc-outline">3.1</span><a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#CMSGC问题探究-1.线上jvm配置" class="toc-link">1.线上jvm配置</a></span></li><li><span class="toc-item-body" data-outline="3.2"><span class="toc-outline">3.2</span><a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#CMSGC问题探究-2.GC日志" class="toc-link">2.GC日志</a></span></li><li><span class="toc-item-body" data-outline="3.3"><span class="toc-outline">3.3</span><a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#CMSGC问题探究-3.问题复现" class="toc-link">3.问题复现</a></span></li></ul></li><li><span class="toc-item-body" data-outline="4"><span class="toc-outline">4</span><a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#CMSGC问题探究-三、解决" class="toc-link">三、解决</a></span></li><li><span class="toc-item-body" data-outline="5"><span class="toc-outline">5</span><a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#CMSGC问题探究-四、问题与思考" class="toc-link">四、问题与思考&nbsp;</a></span><ul style=""><li><span class="toc-item-body" data-outline="5.1"><span class="toc-outline">5.1</span><a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#CMSGC问题探究-1.为什么CMSGC在Cat上显示为FullGC？" class="toc-link">1.为什么CMS GC在Cat上显示为Full GC？</a></span></li><li><span class="toc-item-body" data-outline="5.2"><span class="toc-outline">5.2</span><a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#CMSGC问题探究-2.CMSGC和FullGC有什么区别？" class="toc-link">2.CMS GC和Full GC有什么区别？</a></span></li><li><span class="toc-item-body" data-outline="5.3"><span class="toc-outline">5.3</span><a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#CMSGC问题探究-3.什么情况下触发CMSGC？" class="toc-link">3.什么情况下触发CMS GC？</a></span></li><li><span class="toc-item-body" data-outline="5.4"><span class="toc-outline">5.4</span><a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#CMSGC问题探究-4.什么情况下触发FullGC？" class="toc-link">4.什么情况下触发Full GC？</a></span></li></ul></li><li><span class="toc-item-body" data-outline="6"><span class="toc-outline">6</span><a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#CMSGC问题探究-五、小贴士" class="toc-link">五、小贴士</a></span></li><li><span class="toc-item-body" data-outline="7"><span class="toc-outline">7</span><a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#CMSGC问题探究-六、参考" class="toc-link">六、参考</a></span></li><li><span class="toc-item-body" data-outline="8"><span class="toc-outline">8</span><a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#CMSGC问题探究-七、附录" class="toc-link">七、附录</a></span><ul style=""><li><span class="toc-item-body" data-outline="8.1"><span class="toc-outline">8.1</span><a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#CMSGC问题探究-1.CMSGC源码" class="toc-link">1.CMS GC源码</a></span></li><li><span class="toc-item-body" data-outline="8.2"><span class="toc-outline">8.2</span><a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#CMSGC问题探究-2.CMSFullGC源码" class="toc-link">2.CMS Full GC源码</a></span></li></ul></li></ul></div></h1><h1 id="CMSGC问题探究-一、现象">一、现象</h1><pre>&nbsp; &nbsp; 齿科预订service项目上线十五分钟至二十分钟内，在CAT上会显示产生一次FULL GC（<a href="http://cat.dianpingoa.com/cat/r/h?date=2017090511&amp;ip=10.69.69.116&amp;step=-24&amp;ip=10.69.69.116&amp;domain=dentistry-book-service" class="external-link" rel="nofollow">CAT链接</a>）：</pre><p><span class="confluence-embedded-file-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image" height="250" src="./CMS GC问题探究_files/image2017-9-10 10-51-51.png" data-image-src="/download/attachments/1079095662/image2017-9-10%2010%3A51%3A51.png?version=1&amp;modificationDate=1505011913000&amp;api=v2" data-unresolved-comment-count="0" data-linked-resource-id="1102446831" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image2017-9-10 10:51:51.png" data-base-url="https://wiki.sankuai.com" data-linked-resource-content-type="image/png" data-linked-resource-container-id="1079095662" data-linked-resource-container-version="90"></span></p><pre>具体现场（上线两次，其中23分上线一次，分别在14分钟和36分钟产生两次GC）：</pre><p><span class="confluence-embedded-file-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image" width="800" src="./CMS GC问题探究_files/image2017-9-10 10-53-36.png" data-image-src="/download/attachments/1079095662/image2017-9-10%2010%3A53%3A36.png?version=1&amp;modificationDate=1505012020000&amp;api=v2" data-unresolved-comment-count="0" data-linked-resource-id="1102446840" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image2017-9-10 10:53:36.png" data-base-url="https://wiki.sankuai.com" data-linked-resource-content-type="image/png" data-linked-resource-container-id="1079095662" data-linked-resource-container-version="90"></span><span class="confluence-embedded-file-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image" width="800" src="./CMS GC问题探究_files/image2017-9-10 10-54-5.png" data-image-src="/download/attachments/1079095662/image2017-9-10%2010%3A54%3A5.png?version=1&amp;modificationDate=1505012046000&amp;api=v2" data-unresolved-comment-count="0" data-linked-resource-id="1102446841" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image2017-9-10 10:54:5.png" data-base-url="https://wiki.sankuai.com" data-linked-resource-content-type="image/png" data-linked-resource-container-id="1079095662" data-linked-resource-container-version="90"></span><span class="confluence-embedded-file-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image" width="800" src="./CMS GC问题探究_files/image2017-9-10 10-55-50.png" data-image-src="/download/attachments/1079095662/image2017-9-10%2010%3A55%3A50.png?version=1&amp;modificationDate=1505012152000&amp;api=v2" data-unresolved-comment-count="0" data-linked-resource-id="1102446849" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image2017-9-10 10:55:50.png" data-base-url="https://wiki.sankuai.com" data-linked-resource-content-type="image/png" data-linked-resource-container-id="1079095662" data-linked-resource-container-version="90"></span><span class="confluence-embedded-file-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image" width="800" src="./CMS GC问题探究_files/image2017-9-10 10-56-16.png" data-image-src="/download/attachments/1079095662/image2017-9-10%2010%3A56%3A16.png?version=1&amp;modificationDate=1505012178000&amp;api=v2" data-unresolved-comment-count="0" data-linked-resource-id="1102446850" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image2017-9-10 10:56:16.png" data-base-url="https://wiki.sankuai.com" data-linked-resource-content-type="image/png" data-linked-resource-container-id="1079095662" data-linked-resource-container-version="90"></span><span class="confluence-embedded-file-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image" width="800" src="./CMS GC问题探究_files/image2017-9-10 10-56-45.png" data-image-src="/download/attachments/1079095662/image2017-9-10%2010%3A56%3A45.png?version=1&amp;modificationDate=1505012206000&amp;api=v2" data-unresolved-comment-count="0" data-linked-resource-id="1102446851" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image2017-9-10 10:56:45.png" data-base-url="https://wiki.sankuai.com" data-linked-resource-content-type="image/png" data-linked-resource-container-id="1079095662" data-linked-resource-container-version="90"></span></p><pre>各项指标无明显的异常，业务在GC的时间点也没有抛出大量异常。</pre><pre>&nbsp;</pre><h1 id="CMSGC问题探究-二、过程">二、过程</h1><h2 id="CMSGC问题探究-1.线上jvm配置">1.线上jvm配置</h2><pre>&nbsp; &nbsp; 在tomcat的启动脚本（/usr/local/tomcat/bin/catalina.sh）里：</pre><p><span class="confluence-embedded-file-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image" width="800" src="./CMS GC问题探究_files/image2017-9-10 11-4-14.png" data-image-src="/download/attachments/1079095662/image2017-9-10%2011%3A4%3A14.png?version=1&amp;modificationDate=1505012657000&amp;api=v2" data-unresolved-comment-count="0" data-linked-resource-id="1102446883" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image2017-9-10 11:4:14.png" data-base-url="https://wiki.sankuai.com" data-linked-resource-content-type="image/png" data-linked-resource-container-id="1079095662" data-linked-resource-container-version="90"></span></p><pre>各项参数的含义：</pre><div class="table-wrap"><table class="wrapped relative-table confluenceTable tablesorter tablesorter-default stickyTableHeaders" role="grid" style="padding: 0px;"><colgroup><col><col></colgroup><thead class="tableFloatingHeaderOriginal" style="position: static; margin-top: 0px; left: 95px; z-index: 3; width: 1124px; top: 92px;"><tr role="row" class="tablesorter-headerRow"><th class="confluenceTh tablesorter-header sortableHeader tablesorter-headerUnSorted" data-column="0" tabindex="0" scope="col" role="columnheader" aria-disabled="false" unselectable="on" aria-sort="none" aria-label="参数: No sort applied, activate to apply an ascending sort" style="user-select: none; min-width: 8px; max-width: none;"><div class="tablesorter-header-inner"><p>参数</p></div></th><th class="confluenceTh tablesorter-header sortableHeader tablesorter-headerUnSorted" data-column="1" tabindex="0" scope="col" role="columnheader" aria-disabled="false" unselectable="on" aria-sort="none" aria-label="含义: No sort applied, activate to apply an ascending sort" style="user-select: none; min-width: 8px; max-width: none;"><div class="tablesorter-header-inner"><p>含义</p></div></th></tr></thead><thead class="tableFloatingHeader" style="display: none;"><tr role="row" class="tablesorter-headerRow"><th class="confluenceTh tablesorter-header sortableHeader tablesorter-headerUnSorted" data-column="0" tabindex="0" scope="col" role="columnheader" aria-disabled="false" unselectable="on" aria-sort="none" aria-label="参数: No sort applied, activate to apply an ascending sort" style="user-select: none;"><div class="tablesorter-header-inner"><p>参数</p></div></th><th class="confluenceTh tablesorter-header sortableHeader tablesorter-headerUnSorted" data-column="1" tabindex="0" scope="col" role="columnheader" aria-disabled="false" unselectable="on" aria-sort="none" aria-label="含义: No sort applied, activate to apply an ascending sort" style="user-select: none;"><div class="tablesorter-header-inner"><p>含义</p></div></th></tr></thead><tbody aria-live="polite" aria-relevant="all"><tr role="row"><td class="confluenceTd"><p>-Xms2560m</p></td><td class="confluenceTd"><p>堆初始大小为2560M</p></td></tr><tr role="row"><td class="confluenceTd"><p>-Xmx2560m</p></td><td class="confluenceTd"><p>堆最大为2560M</p></td></tr><tr role="row"><td class="confluenceTd"><p>-Xss512k</p></td><td class="confluenceTd"><p>每个线程堆栈大小为512K</p></td></tr><tr role="row"><td class="confluenceTd"><p>-XX:PermSize=128m</p></td><td class="confluenceTd"><p>持久代（perm gen）初始大小为128M</p></td></tr><tr role="row"><td colspan="1" class="confluenceTd"><p>-XX:MaxPermSize=384m</p></td><td colspan="1" class="confluenceTd"><p>持久代最大为384M</p></td></tr><tr role="row"><td colspan="1" class="confluenceTd"><p>-XX:NewSize=1536m</p></td><td colspan="1" class="confluenceTd"><p>新生代初始大小为1536M</p></td></tr><tr role="row"><td colspan="1" class="confluenceTd"><p>-XX:MaxNewSize=1536m</p></td><td colspan="1" class="confluenceTd"><p>新生代最大为1536M</p></td></tr><tr role="row"><td colspan="1" class="confluenceTd"><p>-XX:SurvivorRatio=22</p></td><td colspan="1" class="confluenceTd"><p>新生代Eden区与Survivor区的比值，因为新生代大小为1536，Eden区大小为1536*22/(22+2)=1408，每个Survivor区为64M</p></td></tr><tr role="row"><td colspan="1" class="confluenceTd"><p>-XX:+UseParNewGC</p></td><td colspan="1" class="confluenceTd"><p>新生代垃圾收集器为ParNew，可与CMS同时使用</p></td></tr><tr role="row"><td colspan="1" class="confluenceTd"><p>-XX:ParallelGCThreads=4</p></td><td colspan="1" class="confluenceTd"><p>并行收集的线程数为4</p></td></tr><tr role="row"><td colspan="1" class="confluenceTd"><p>-XX:MaxTenuringThreshold=9</p></td><td colspan="1" class="confluenceTd"><p>对象晋升老年代的年龄阈值为9</p></td></tr><tr role="row"><td colspan="1" class="confluenceTd"><p>-XX:+UseConcMarkSweepGC</p></td><td colspan="1" class="confluenceTd"><p>老年代使用CMS垃圾收集器</p></td></tr><tr role="row"><td colspan="1" class="confluenceTd"><p>-XX:+DisableExplicitGC</p></td><td colspan="1" class="confluenceTd"><p>禁用System.gc()</p></td></tr><tr role="row"><td colspan="1" class="confluenceTd"><p>-XX:+UseCMSInitiatingOccupancyOnly</p></td><td colspan="1" class="confluenceTd"><p>指定HotSpot VM总是使用-XX:CMSInitiatingOccupancyFraction的值作为老年代使用率限制来启动CMS垃圾回收。如果没有使用-XX:+UseCMSInitiatingOccupancyOnly，那么HotSpot VM只是利用CMSInitiatingOccupancyFraction启动第一次CMS垃圾回收，后面都是使用HotSpot VM自动计算出来的值</p></td></tr><tr role="row"><td colspan="1" class="confluenceTd"><p>-XX:+ScavengeBeforeFullGC</p></td><td colspan="1" class="confluenceTd"><p>在Full GC前触发一次Minor GC</p></td></tr><tr role="row"><td colspan="1" class="confluenceTd"><p>-XX:+UseCMSCompactAtFullCollection</p></td><td colspan="1" class="confluenceTd"><p>FULL GC时对老年代进行压缩。CMS默认不会移动内存，因此容易产生碎片。增加该参数虽然会影响性能，但可以消除碎片</p></td></tr><tr role="row"><td colspan="1" class="confluenceTd"><p>-XX:+CMSParallelRemarkEnabled</p></td><td colspan="1" class="confluenceTd"><p>开启并行标记，减少停顿时间</p></td></tr><tr role="row"><td colspan="1" class="confluenceTd"><p>-XX:CMSFullGCsBeforeCompaction=9</p></td><td colspan="1" class="confluenceTd"><p>9次以后进行内存压缩。由于并发收集器不对内存空间进行压缩整理，所以运行一段时间以后会产生"碎片",使得运行效率降低.此值设置运行多少次GC以后对内存空间进行压缩整理</p></td></tr><tr role="row"><td colspan="1" class="confluenceTd"><p>-XX:CMSInitiatingOccupancyFraction=60</p></td><td colspan="1" class="confluenceTd"><p>老年代使用率达到60%时，触发GC回收</p></td></tr><tr role="row"><td colspan="1" class="confluenceTd"><p>-XX:+CMSClassUnloadingEnabled</p></td><td colspan="1" class="confluenceTd"><p>垃圾回收会清理持久代，移除不再使用的classes。这个参数只有在UseConcMarkSweepGC也启用的情况下才有用</p></td></tr><tr role="row"><td colspan="1" class="confluenceTd"><p>-XX:SoftRefLRUPolicyMSPerMB=0</p></td><td colspan="1" class="confluenceTd"><p>每MB堆中软引用(soft reference)对象的存活时间。软引用用于描述一些有用但并非必须的对象。对于软引用关联的对象，在系统将要发生内存溢出异常之前，将会把这些对象列入回收范围内进行二次回收。如果这次回收还没有足够内存，才会抛出内存溢出异常</p></td></tr><tr role="row"><td colspan="1" class="confluenceTd"><p>-XX:-ReduceInitialCardMarks</p></td><td colspan="1" class="confluenceTd"><p>为解决jdk 6u18 放入大对象导致jvm crash的一个配置参数</p></td></tr><tr role="row"><td colspan="1" class="confluenceTd"><p>-XX:+CMSPermGenSweepingEnabled</p></td><td colspan="1" class="confluenceTd"><p>允许对持久代进行清理</p></td></tr><tr role="row"><td colspan="1" class="confluenceTd"><p>-XX:CMSInitiatingPermOccupancyFraction=70</p></td><td colspan="1" class="confluenceTd"><p>持久代使用率超过70%触发GC</p></td></tr><tr role="row"><td colspan="1" class="confluenceTd"><p>-XX:+ExplicitGCInvokesConcurrent</p></td><td colspan="1" class="confluenceTd"><p>命令JVM无论什么时候调用系统GC，都执行CMS GC，而不是Full GC （<a href="http://blog.csdn.net/aesop_wubo/article/details/38406709" class="external-link" rel="nofollow">一个case</a>）</p></td></tr><tr role="row"><td colspan="1" class="confluenceTd"><p>-Djava.nio.channels.spi.SelectorProvider=<a href="http://sun.nio.ch/" class="external-link" rel="nofollow">sun.nio.ch</a>.EPollSelectorProvider</p></td><td colspan="1" class="confluenceTd"><p>/</p></td></tr><tr role="row"><td colspan="1" class="confluenceTd"><p>-Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager</p></td><td colspan="1" class="confluenceTd"><p>/</p></td></tr><tr role="row"><td colspan="1" class="confluenceTd"><p>-Djava.util.logging.config.file="%CATALINA_HOME%\conf\logging.properties"</p></td><td colspan="1" class="confluenceTd"><p>/</p></td></tr><tr role="row"><td colspan="1" class="confluenceTd"><p>-XX:+PrintGCDetails</p></td><td colspan="1" class="confluenceTd"><p>打印GC详情</p></td></tr><tr role="row"><td colspan="1" class="confluenceTd"><p>-XX:+PrintGCTimeStamps</p></td><td colspan="1" class="confluenceTd"><p>打印GC停顿耗时</p></td></tr><tr role="row"><td colspan="1" class="confluenceTd"><p>-XX:+PrintGCApplicationConcurrentTime</p></td><td colspan="1" class="confluenceTd"><p>打印每次垃圾回收前，程序未中断的执行时间</p></td></tr><tr role="row"><td colspan="1" class="confluenceTd"><p>-XX:+PrintHeapAtGC</p></td><td colspan="1" class="confluenceTd"><p>打印GC前后的详细堆栈信息</p></td></tr><tr role="row"><td colspan="1" class="confluenceTd"><p><a rel="nofollow">-Xloggc:/data/applogs/heap_trace.txt</a></p></td><td colspan="1" class="confluenceTd"><p>日志信息地址</p></td></tr><tr role="row"><td colspan="1" class="confluenceTd"><p>-XX:-HeapDumpOnOutOfMemoryError</p></td><td colspan="1" class="confluenceTd"><p>在java.lang.OutOfMemoryError异常出现时，输出一个dump.core文件，记录当时的堆内存快照</p></td></tr><tr role="row"><td colspan="1" class="confluenceTd"><p>-XX:HeapDumpPath=/data/applogs/HeapDumpOnOutOfMemoryError</p></td><td colspan="1" class="confluenceTd"><p>堆内存快照地址</p></td></tr></tbody></table></div><pre>&nbsp;</pre><pre>堆内存划分：</pre><p><span class="confluence-embedded-file-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image" width="400" src="./CMS GC问题探究_files/image2017-9-10 11-47-31.png" data-image-src="/download/attachments/1079095662/image2017-9-10%2011%3A47%3A31.png?version=1&amp;modificationDate=1505015253000&amp;api=v2" data-unresolved-comment-count="0" data-linked-resource-id="1102447320" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image2017-9-10 11:47:31.png" data-base-url="https://wiki.sankuai.com" data-linked-resource-content-type="image/png" data-linked-resource-container-id="1079095662" data-linked-resource-container-version="90"></span></p><h2 id="CMSGC问题探究-2.GC日志">2.GC日志</h2><pre>GC日志位置由jvm配置<a rel="nofollow">-Xloggc:/data/applogs/heap_trace.txt</a>决定</pre><div class="code panel pdl conf-macro output-block" style="border-width: 1px;" data-hasbody="true" data-macro-name="code"><div class="codeContent panelContent pdl">
                        <div><div id="highlighter_429031" class="syntaxhighlighter sh-rdark  java"><div class="toolbar"><span><a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div></td><td class="code"><div class="container" title="Hint: double-click to select code"><div class="line number1 index0 alt2"><code class="java value">752.473</code><code class="java plain">: [GC [</code><code class="java value">1</code> <code class="java plain">CMS-initial-mark: 61842K(1048576K)] 1161481K(2555904K), </code><code class="java value">0.7586700</code> <code class="java plain">secs] [Times: user=</code><code class="java value">0.76</code> <code class="java plain">sys=</code><code class="java value">0.00</code><code class="java plain">, real=</code><code class="java value">0.75</code> <code class="java plain">secs] </code></div><div class="line number2 index1 alt1"><code class="java value">753.232</code><code class="java plain">: [CMS-concurrent-mark-start]</code></div><div class="line number3 index2 alt2"><code class="java plain">......</code></div><div class="line number4 index3 alt1">&nnbsp;</div><div class="line number5 index4 alt2"><code class="java plain">......&nbsp;</code></div><div class="line number6 index5 alt1"><code class="java value">753.412</code><code class="java plain">: [CMS-concurrent-mark: </code><code class="java value">0.172</code><code class="java plain">/</code><code class="java value">0.180</code> <code class="java plain">secs] [Times: user=</code><code class="java value">0.28</code> <code class="java plain">sys=</code><code class="java value">0.04</code><code class="java plain">, real=</code><code class="java value">0.18</code> <code class="java plain">secs] </code></div><div class="line number7 index6 alt2"><code class="java value">753.412</code><code class="java plain">: [CMS-concurrent-preclean-start]</code></div><div class="line number8 index7 alt1"><code class="java value">753.422</code><code class="java plain">: [CMS-concurrent-preclean: </code><code class="java value">0.009</code><code class="java plain">/</code><code class="java value">0.010</code> <code class="java plain">secs] [Times: user=</code><code class="java value">0.01</code> <code class="java plain">sys=</code><code class="java value">0.00</code><code class="java plain">, real=</code><code class="java value">0.01</code> <code class="java plain">secs] </code></div><div class="line number9 index8 alt2"><code class="java value">753.422</code><code class="java plain">: [CMS-concurrent-abortable-preclean-start]</code></div><div class="line number10 index9 alt1"><code class="java plain">......</code></div><div class="line number11 index10 alt2">&nbsp;</div><div class="line number12 index11 alt1"><code class="java plain">......&nbsp;</code></div><div class="line number13 index12 alt2"><code class="java spaces">&nbsp;</code><code class="java plain">CMS: abort preclean due to time </code><code class="java value">758.432</code><code class="java plain">: [CMS-concurrent-abortable-preclean: </code><code class="java value">3.548</code><code class="java plain">/</code><code class="java value">5.010</code> <code class="java plain">secs] [Times: user=</code><code class="java value">4.55</code> <code class="java plain">sys=</code><code class="java value">0.39</code><code class="java plain">, real=</code><code class="java value">5.01</code> <code class="java plain">secs] </code></div><div class="line number14 index13 alt1"><code class="java plain">......</code></div><div class="line number15 index14 alt2"><code class="java value">758.433</code><code class="java plain">: [GC[YG occupancy: </code><code class="java value">1321915</code> <code class="java plain">K (</code><code class="java value">1507328</code> <code class="java plain">K)]</code><code class="java value">758.433</code><code class="java plain">: [Rescan (parallel) , </code><code class="java value">0.9027360</code> <code class="java plain">secs]</code><code class="java value">759.336</code><code class="java plain">: [weak refs processing, </code><code class="java value">0.0011200</code> <code class="java plain">secs]</code><code class="java value">759.337</code><code class="java plain">: [</code><code class="java keyword">class</code> <code class="java plain">unloading, </code><code class="java value">0.0118200</code> <code class="java plain">secs]</code><code class="java value">759.349</code><code class="java plain">: [scrub symbol table, </code><code class="java value">0.0162340</code> <code class="java plain">secs]</code><code class="java value">759.365</code><code class="java plain">: [scrub string table, </code><code class="java value">0.0021800</code> <code class="java plain">secs] [</code><code class="java value">1</code> <code class="java plain">CMS-remark: 61842K(1048576K)] 1383758K(2555904K), </code><code class="java value">0.9383200</code> <code class="java plain">secs] [Times: user=</code><code class="java value">3.56</code> <code class="java plain">sys=</code><code class="java value">0.00</code><code class="java plain">, real=</code><code class="java value">0.94</code> <code class="java plain">secs] </code></div><div class="line number16 index15 alt1"><code class="java value">759.372</code><code class="java plain">: [CMS-concurrent-sweep-start]</code></div><div class="line number17 index16 alt2"><code class="java plain">......</code></div><div class="line number18 index17 alt1"><code class="java spaces">&nbsp;</code>&nbsp;</div><div class="line number19 index18 alt2"><code class="java plain">......</code></div><div class="line number20 index19 alt1"><code class="java value">759.432</code><code class="java plain">: [CMS-concurrent-sweep: </code><code class="java value">0.050</code><code class="java plain">/</code><code class="java value">0.060</code> <code class="java plain">secs] [Times: user=</code><code class="java value">0.13</code> <code class="java plain">sys=</code><code class="java value">0.00</code><code class="java plain">, real=</code><code class="java value">0.06</code> <code class="java plain">secs] </code></div><div class="line number21 index20 alt2"><code class="java value">759.432</code><code class="java plain">: [CMS-concurrent-reset-start]</code></div><div class="line number22 index21 alt1"><code class="java value">759.437</code><code class="java plain">: [CMS-concurrent-reset: </code><code class="java value">0.004</code><code class="java plain">/</code><code class="java value">0.004</code> <code class="java plain">secs] [Times: user=</code><code class="java value">0.00</code> <code class="java plain">sys=</code><code class="java value">0.01</code><code class="java plain">, real=</code><code class="java value">0.01</code> <code class="java plain">secs] </code></div><div class="line number23 index22 alt2"><code class="java plain">......</code></div><div class="line number24 index23 alt1"><code class="java plain">...</code></div></div></td></tr></tbody></table></div></div>
                    </div></div><pre>CMS GC主要分成四个阶段：</pre><div class="table-wrap"><table class="wrapped confluenceTable tablesorter tablesorter-default stickyTableHeaders" role="grid" style="padding: 0px;"><colgroup><col><col><col><col></colgroup><thead class="tableFloatingHeaderOriginal" style="position: static; margin-top: 0px; left: 95px; z-index: 3; width: 1085px; top: 92px;"><tr role="row" class="tablesorter-headerRow"><th colspan="1" class="confluenceTh tablesorter-header sortableHeader tablesorter-headerUnSorted" data-column="0" tabindex="0" scope="col" role="columnheader" aria-disabled="false" unselectable="on" aria-sort="none" aria-label="顺序: No sort applied, activate to apply an ascending sort" style="user-select: none; min-width: 8px; max-width: none;"><div class="tablesorter-header-inner"><pre>顺序</pre></div></th><th class="confluenceTh tablesorter-header sortableHeader tablesorter-headerUnSorted" data-column="1" tabindex="0" scope="col" role="columnheader" aria-disabled="false" unselectable="on" aria-sort="none" aria-label="阶段: No sort applied, activate to apply an ascending sort" style="user-select: none; min-width: 8px; max-width: none;"><div class="tablesorter-header-inner"><pre>阶段</pre></div></th><th class="confluenceTh tablesorter-header sortableHeader tablesorter-headerUnSorted" data-column="2" tabindex="0" scope="col" role="columnheader" aria-disabled="false" unselectable="on" aria-sort="none" aria-label="说明: No sort applied, activate to apply an ascending sort" style="user-select: none; min-width: 8px; max-width: none;"><div class="tablesorter-header-inner"><pre>说明</pre></div></th><th class="confluenceTh tablesorter-header sortableHeader tablesorter-headerUnSorted" data-column="3" tabindex="0" scope="col" role="columnheader" aria-disabled="false" unselectable="on" aria-sort="none" aria-label="日志解析: No sort applied, activate to apply an ascending sort" style="user-select: none; min-width: 8px; max-width: none;"><div class="tablesorter-header-inner"><pre>日志解析</pre></div></th></tr></thead><thead class="tableFloatingHeader" style="display: none;"><tr role="row" class="tablesorter-headerRow"><th colspan="1" class="confluenceTh tablesorter-header sortableHeader tablesorter-headerUnSorted" data-column="0" tabindex="0" scope="col" role="columnheader" aria-disabled="false" unselectable="on" aria-sort="none" aria-label="顺序: No sort applied, activate to apply an ascending sort" style="user-select: none;"><div class="tablesorter-header-inner"><pre>顺序</pre></div></th><th class="confluenceTh tablesorter-header sortableHeader tablesorter-headerUnSorted" data-column="1" tabindex="0" scope="col" role="columnheader" aria-disabled="false" unselectable="on" aria-sort="none" aria-label="阶段: No sort applied, activate to apply an ascending sort" style="user-select: none;"><div class="tablesorter-header-inner"><pre>阶段</pre></div></th><th class="confluenceTh tablesorter-header sortableHeader tablesorter-headerUnSorted" data-column="2" tabindex="0" scope="col" role="columnheader" aria-disabled="false" unselectable="on" aria-sort="none" aria-label="说明: No sort applied, activate to apply an ascending sort" style="user-select: none;"><div class="tablesorter-header-inner"><pre>说明</pre></div></th><th class="confluenceTh tablesorter-header sortableHeader tablesorter-headerUnSorted" data-column="3" tabindex="0" scope="col" role="columnheader" aria-disabled="false" unselectable="on" aria-sort="none" aria-label="日志解析: No sort applied, activate to apply an ascending sort" style="user-select: none;"><div class="tablesorter-header-inner"><pre>日志解析</pre></div></th></tr></thead><tbody aria-live="polite" aria-relevant="all"><tr role="row"><td colspan="1" class="confluenceTd"><p>1</p></td><td class="confluenceTd"><p>initial mark</p><p>初始标记</p></td><td class="confluenceTd"><p>该阶段标记从GC Roots直接可达的老年代对象，</p><p>需要stop the world</p></td><td class="confluenceTd"><p>[GC [1 CMS-initial-mark: 61842K(1048576K)] 1161481K(2555904K), 0.7586700 secs]</p><p>[Times: user=0.76 sys=0.00, real=0.75 secs]</p><p>老年代容量为1048576K，使用达到61842K时被触发，整个过程耗时0.7586700秒。</p></td></tr><tr role="row"><td colspan="1" class="confluenceTd"><p>2</p></td><td class="confluenceTd"><p>concurrent mark</p><p>并发标记</p></td><td class="confluenceTd">&nbsp;</td><td class="confluenceTd"><p>[CMS-concurrent-mark-start]</p><p>之前暂停的线程继续执行。从第一阶段被标记的对象出发，标记所有可达对象。</p><p>[CMS-concurrent-mark: 0.172/0.180 secs] [Times: user=0.28 sys=0.04, real=0.18 secs]</p><p>并发标记占用了0.172 CPU执行时间，0.180秒总时间（包含业务线程执行时间）。</p></td></tr><tr role="row"><td colspan="1" class="confluenceTd"><p>3</p></td><td class="confluenceTd"><p>remark</p><p>重新标记</p></td><td class="confluenceTd"><p>在并发标记阶段，应用正在运行并更新引用，</p><p>所以并发标记结束时，</p><p>并非所有存活对象都能被标记，</p><p>因此需要遍历所有在并发标记阶段有变动的对象，</p><p>进行最后标记。</p><p>该阶段需要stop the world</p></td><td class="confluenceTd"><p>[GC[YG occupancy: 1321915 K (1507328 K)]</p><p>758.433: [Rescan (parallel) , 0.9027360 secs]</p><p>759.336: [weak refs processing, 0.0011200 secs]</p><p>759.337: [class unloading, 0.0118200 secs]</p><p>759.349: [scrub symbol table, 0.0162340 secs]</p><p>759.365: [scrub string table, 0.0021800 secs]&nbsp;</p><p>[1 CMS-remark: 61842K(1048576K)] 1383758K(2555904K), 0.9383200 secs]</p><p>[Times: user=3.56 sys=0.00, real=0.94 secs]&nbsp;</p><p>重新扫描耗时0.9027360秒，处理弱引用对象0.0011200秒，本阶段耗时0.9383200秒。</p></td></tr><tr role="row"><td colspan="1" class="confluenceTd"><p>4</p></td><td colspan="1" class="confluenceTd"><p>concurrent sweep</p><p>并发清除</p></td><td colspan="1" class="confluenceTd"><p>清除整个java堆，释放没有迁移的垃圾对象</p></td><td colspan="1" class="confluenceTd"><p>[CMS-concurrent-sweep-start]</p><p>[CMS-concurrent-sweep: 0.050/0.060 secs] [Times: user=0.13 sys=0.00, real=0.06 secs]</p><p>并发清除耗时0.050秒</p></td></tr></tbody></table></div><pre>整个GC过程stop the world一共 0.7586700 + 0.9383200 = 1.69699秒。</pre><pre>除了以上四个主要阶段，为了提升性能，CMS还引入了三个阶段：</pre><div class="table-wrap"><table class="wrapped confluenceTable tablesorter tablesorter-default stickyTableHeaders" role="grid" style="padding: 0px;"><colgroup><col><col><col><col></colgroup><thead class="tableFloatingHeaderOriginal" style="position: static; margin-top: 0px; left: 95px; z-index: 3; width: 1124px; top: 92px;"><tr role="row" class="tablesorter-headerRow"><th colspan="1" class="confluenceTh tablesorter-header sortableHeader tablesorter-headerUnSorted" data-column="0" tabindex="0" scope="col" role="columnheader" aria-disabled="false" unselectable="on" aria-sort="none" aria-label="顺序: No sort applied, activate to apply an ascending sort" style="user-select: none; min-width: 8px; max-width: none;"><div class="tablesorter-header-inner"><pre>顺序</pre></div></th><th class="confluenceTh tablesorter-header sortableHeader tablesorter-headerUnSorted" data-column="1" tabindex="0" scope="col" role="columnheader" aria-disabled="false" unselectable="on" aria-sort="none" aria-label="阶段: No sort applied, activate to apply an ascending sort" style="user-select: none; min-width: 8px; max-width: none;"><div class="tablesorter-header-inner"><pre>阶段</pre></div></th><th class="confluenceTh tablesorter-header sortableHeader tablesorter-headerUnSorted" data-column="2" tabindex="0" scope="col" role="columnheader" aria-disabled="false" unselectable="on" aria-sort="none" aria-label="说明: No sort applied, activate to apply an ascending sort" style="user-select: none; min-width: 8px; max-width: none;"><div class="tablesorter-header-inner"><pre>说明</pre></div></th><th class="confluenceTh tablesorter-header sortableHeader tablesorter-headerUnSorted" data-column="3" tabindex="0" scope="col" role="columnheader" aria-disabled="false" unselectable="on" aria-sort="none" aria-label="日志解析: No sort applied, activate to apply an ascending sort" style="user-select: none; min-width: 8px; max-width: none;"><div class="tablesorter-header-inner"><pre>日志解析</pre></div></th></tr></thead><thead class="tableFloatingHeader" style="display: none;"><tr role="row" class="tablesorter-headerRow"><th colspan="1" class="confluenceTh tablesorter-header sortableHeader tablesorter-headerUnSorted" data-column="0" tabindex="0" scope="col" role="columnheader" aria-disabled="false" unselectable="on" aria-sort="none" aria-label="顺序: No sort applied, activate to apply an ascending sort" style="user-select: none;"><div class="tablesorter-header-inner"><pre>顺序</pre></div></th><th class="confluenceTh tablesorter-header sortableHeader tablesorter-headerUnSorted" data-column="1" tabindex="0" scope="col" role="columnheader" aria-disabled="false" unselectable="on" aria-sort="none" aria-label="阶段: No sort applied, activate to apply an ascending sort" style="user-select: none;"><div class="tablesorter-header-inner"><pre>阶段</pre></div></th><th class="confluenceTh tablesorter-header sortableHeader tablesorter-headerUnSorted" data-column="2" tabindex="0" scope="col" role="columnheader" aria-disabled="false" unselectable="on" aria-sort="none" aria-label="说明: No sort applied, activate to apply an ascending sort" style="user-select: none;"><div class="tablesorter-header-inner"><pre>说明</pre></div></th><th class="confluenceTh tablesorter-header sortableHeader tablesorter-headerUnSorted" data-column="3" tabindex="0" scope="col" role="columnheader" aria-disabled="false" unselectable="on" aria-sort="none" aria-label="日志解析: No sort applied, activate to apply an ascending sort" style="user-select: none;"><div class="tablesorter-header-inner"><pre>日志解析</pre></div></th></tr></thead><tbody aria-live="polite" aria-relevant="all"><tr role="row"><td colspan="1" class="confluenceTd"><p>2.5</p></td><td class="confluenceTd"><p>concurrent preclean</p><p>并发预清除</p></td><td class="confluenceTd"><p>为了减少重新标记（需要stop the world）的工作量而引入。</p></td><td class="confluenceTd"><p>[CMS-concurrent-preclean-start]</p><p>[CMS-concurrent-preclean: 0.009/0.010 secs] [Times: user=0.01 sys=0.00, real=0.01 secs]&nbsp;</p></td></tr><tr role="row"><td colspan="1" class="confluenceTd"><p>2.75</p></td><td colspan="1" class="confluenceTd"><p>concurrent abortable preclean</p><p>并发可终止预清除</p></td><td colspan="1" class="confluenceTd"><p>可中止预清理阶段，运行在并行预清理和重新标记之间，</p><p>直到获得所期望的eden空间占用率。</p><p>增加这个阶段是为了避免在重新标记阶段后紧跟着发生一次垃圾清除。</p><p>为了尽可能区分开垃圾清除和重新标记 ，</p><p>我们尽量安排在两次垃圾清除之间运行重新标记阶段。</p></td><td colspan="1" class="confluenceTd"><p>[CMS-concurrent-abortable-preclean-start]</p><p>CMS: abort preclean due to time 758.432:</p><p>[CMS-concurrent-abortable-preclean: 3.548/5.010 secs] [Times: user=4.55 sys=0.39, real=5.01 secs]</p></td></tr><tr role="row"><td colspan="1" class="confluenceTd"><p>4.5</p></td><td class="confluenceTd"><p>concurrent reset</p><p>并发重置</p></td><td class="confluenceTd"><p>最后一阶段。</p></td><td class="confluenceTd"><p>[CMS-concurrent-reset-start]<br>[CMS-concurrent-reset: 0.004/0.004 secs] [Times: user=0.00 sys=0.01, real=0.01 secs]</p></td></tr></tbody></table></div><p><br>观察GC日志并没有出现FULL字样，没有明显的异常。&nbsp;</p><h2 id="CMSGC问题探究-3.问题复现">3.问题复现</h2><pre>&nbsp;使用jmap -heap pid打印虚拟机内存分配情况，观察GC前后的对比：</pre><div class="table-wrap"><table class="wrapped confluenceTable tablesorter tablesorter-default stickyTableHeaders" role="grid" style="padding: 0px;"><colgroup><col><col><col></colgroup><thead class="tableFloatingHeaderOriginal" style="position: static; margin-top: 0px; left: 95px; z-index: 3; width: 987px; top: 92px;"><tr role="row" class="tablesorter-headerRow"><th class="confluenceTh tablesorter-header sortableHeader tablesorter-headerUnSorted" data-column="0" tabindex="0" scope="col" role="columnheader" aria-disabled="false" unselectable="on" aria-sort="none" aria-label="应用刚启动: No sort applied, activate to apply an ascending sort" style="user-select: none; min-width: 8px; max-width: none;"><div class="tablesorter-header-inner"><pre>应用刚启动</pre></div></th><th colspan="1" class="confluenceTh tablesorter-header sortableHeader tablesorter-headerUnSorted" data-column="1" tabindex="0" scope="col" role="columnheader" aria-disabled="false" unselectable="on" aria-sort="none" aria-label=" 刚GC后: No sort applied, activate to apply an ascending sort" style="user-select: none; min-width: 8px; max-width: none;"><div class="tablesorter-header-inner"><pre>&nbsp;刚GC后</pre></div></th><th class="confluenceTh tablesorter-header sortableHeader tablesorter-headerUnSorted" data-column="2" tabindex="0" scope="col" role="columnheader" aria-disabled="false" unselectable="on" aria-sort="none" aria-label=" 运行稳定后: No sort applied, activate to apply an ascending sort" style="user-select: none; min-width: 8px; max-width: none;"><div class="tablesorter-header-inner"><pre>&nbsp;运行稳定后</pre></div></th></tr></thead><thead class="tableFloatingHeader" style="display: none;"><tr role="row" class="tablesorter-headerRow"><th class="confluenceTh tablesorter-header sortableHeader tablesorter-headerUnSorted" data-column="0" tabindex="0" scope="col" role="columnheader" aria-disabled="false" unselectable="on" aria-sort="none" aria-label="应用刚启动: No sort applied, activate to apply an ascending sort" style="user-select: none;"><div class="tablesorter-header-inner"><pre>应用刚启动</pre></div></th><th colspan="1" class="confluenceTh tablesorter-header sortableHeader tablesorter-headerUnSorted" data-column="1" tabindex="0" scope="col" role="columnheader" aria-disabled="false" unselectable="on" aria-sort="none" aria-label=" 刚GC后: No sort applied, activate to apply an ascending sort" style="user-select: none;"><div class="tablesorter-header-inner"><pre>&nbsp;刚GC后</pre></div></th><th class="confluenceTh tablesorter-header sortableHeader tablesorter-headerUnSorted" data-column="2" tabindex="0" scope="col" role="columnheader" aria-disabled="false" unselectable="on" aria-sort="none" aria-label=" 运行稳定后: No sort applied, activate to apply an ascending sort" style="user-select: none;"><div class="tablesorter-header-inner"><pre>&nbsp;运行稳定后</pre></div></th></tr></thead><tbody aria-live="polite" aria-relevant="all"><tr role="row"><td class="confluenceTd"><p>Heap Usage:</p><p>New Generation (Eden + 1 Survivor Space):<br> capacity = 1543503872 (1472.0MB)<br> used = 634222712 (604.841911315918MB)<br> free = 909281160 (867.158088684082MB)<br> 41.08980375787486% used<br>Eden Space:<br> capacity = 1476395008 (1408.0MB)<br> used = 599128768 (571.3737182617188MB)<br> free = 877266240 (836.6262817382812MB)<br> 40.580519762906164% used<br>From Space:<br> capacity = 67108864 (64.0MB)<br> used = 35093944 (33.46819305419922MB)<br> free = 32014920 (30.53180694580078MB)<br> 52.29405164718628% used<br>To Space:<br> capacity = 67108864 (64.0MB)<br> used = 0 (0.0MB)<br> free = 67108864 (64.0MB)<br> 0.0% used<br>concurrent mark-sweep generation:<br> capacity = 1073741824 (1024.0MB)<br> used = 39692400 (37.85362243652344MB)<br> free = 1034049424 (986.1463775634766MB)<br> 3.696642816066742% used<br>Perm Generation:<br><span style="color: rgb(255,0,0);"> capacity = 134217728 (128.0MB)</span><br><span style="color: rgb(255,0,0);"> used = 92659176 (88.3666763305664MB)</span><br><span style="color: rgb(255,0,0);"> free = 41558552 (39.633323669433594MB)</span><br><span style="color: rgb(255,0,0);"> 69.036465883255% used</span></p><p>46590 interned Strings occupying 5421560 bytes.</p></td><td colspan="1" class="confluenceTd"><p>Heap Usage:</p><p>New Generation (Eden + 1 Survivor Space):<br> capacity = 1543503872 (1472.0MB)<br> used = 1278377840 (1219.1561126708984MB)<br> free = 265126032 (252.84388732910156MB)<br> 82.82310548035994% used<br>Eden Space:<br> capacity = 1476395008 (1408.0MB)<br> used = 1235813512 (1178.563606262207MB)<br> free = 240581496 (229.43639373779297MB)<br> 83.70480158112265% used<br>From Space:<br> capacity = 67108864 (64.0MB)<br> used = 42564328 (40.592506408691406MB)<br> free = 24544536 (23.407493591308594MB)<br> 63.42579126358032% used<br>To Space:<br> capacity = 67108864 (64.0MB)<br> used = 0 (0.0MB)<br> free = 67108864 (64.0MB)<br> 0.0% used<br>concurrent mark-sweep generation:<br> capacity = 1073741824 (1024.0MB)<br> used = 35266656 (33.632904052734375MB)<br> free = 1038475168 (990.3670959472656MB)<br> 3.2844632863998413% used<br>Perm Generation:<br> <span style="color: rgb(255,0,0);">capacity = 156258304 (149.01953125MB)</span><br><span style="color: rgb(255,0,0);"> used = 93752880 (89.40971374511719MB)</span><br><span style="color: rgb(255,0,0);"> free = 62505424 (59.60981750488281MB)</span><br><span style="color: rgb(255,0,0);"> 59.998654535505516% used</span></p><p>33406 interned Strings occupying 3619952 bytes.</p></td><td class="confluenceTd"><p>Heap Usage:</p><p>New Generation (Eden + 1 Survivor Space):<br> capacity = 1543503872 (1472.0MB)<br> used = 985552344 (939.8959579467773MB)<br> free = 557951528 (532.1040420532227MB)<br> 63.85162757790607% used<br>Eden Space:<br> capacity = 1476395008 (1408.0MB)<br> used = 979146656 (933.7870178222656MB)<br> free = 497248352 (474.2129821777344MB)<br> 66.32010069760409% used<br>From Space:<br> capacity = 67108864 (64.0MB)<br> used = 6405688 (6.108940124511719MB)<br> free = 60703176 (57.89105987548828MB)<br> 9.54521894454956% used<br>To Space:<br> capacity = 67108864 (64.0MB)<br> used = 0 (0.0MB)<br> free = 67108864 (64.0MB)<br> 0.0% used<br>concurrent mark-sweep generation:<br> capacity = 1073741824 (1024.0MB)<br> used = 81713072 (77.92765808105469MB)<br> free = 992028752 (946.0723419189453MB)<br> 7.610122859477997% used<br>Perm Generation:<br> <span style="color: rgb(255,0,0);">capacity = 156258304 (149.01953125MB)</span><br><span style="color: rgb(255,0,0);"> used = 96819112 (92.33390045166016MB)</span><br><span style="color: rgb(255,0,0);"> free = 59439192 (56.685630798339844MB)</span><br><span style="color: rgb(255,0,0);"> 61.960938728734696% used</span></p><p>35036 interned Strings occupying 3771512 bytes.</p></td></tr></tbody></table></div><pre>再仔细观察jvm参数：</pre><div class="table-wrap"><table class="wrapped confluenceTable tablesorter tablesorter-default stickyTableHeaders" role="grid" style="padding: 0px;"><colgroup><col><col></colgroup><thead class="tableFloatingHeaderOriginal" style="position: static; margin-top: 0px; left: 95px; z-index: 3; width: 628px; top: 92px;"><tr role="row" class="tablesorter-headerRow"><th class="confluenceTh tablesorter-header sortableHeader tablesorter-headerUnSorted" data-column="0" tabindex="0" scope="col" role="columnheader" aria-disabled="false" unselectable="on" aria-sort="none" aria-label="参数: No sort applied, activate to apply an ascending sort" style="user-select: none; min-width: 8px; max-width: none;"><div class="tablesorter-header-inner">参数</div></th><th class="confluenceTh tablesorter-header sortableHeader tablesorter-headerUnSorted" data-column="1" tabindex="0" scope="col" role="columnheader" aria-disabled="false" unselectable="on" aria-sort="none" aria-label="含义: No sort applied, activate to apply an ascending sort" style="user-select: none; min-width: 8px; max-width: none;"><div class="tablesorter-header-inner">含义</div></th></tr></thead><thead class="tableFloatingHeader" style="display: none;"><tr role="row" class="tablesorter-headerRow"><th class="confluenceTh tablesorter-header sortableHeader tablesorter-headerUnSorted" data-column="0" tabindex="0" scope="col" role="columnheader" aria-disabled="false" unselectable="on" aria-sort="none" aria-label="参数: No sort applied, activate to apply an ascending sort" style="user-select: none;"><div class="tablesorter-header-inner">参数</div></th><th class="confluenceTh tablesorter-header sortableHeader tablesorter-headerUnSorted" data-column="1" tabindex="0" scope="col" role="columnheader" aria-disabled="false" unselectable="on" aria-sort="none" aria-label="含义: No sort applied, activate to apply an ascending sort" style="user-select: none;"><div class="tablesorter-header-inner">含义</div></th></tr></thead><tbody aria-live="polite" aria-relevant="all"><tr role="row"><td class="confluenceTd"><pre>-XX:PermSize=128m</pre></td><td class="confluenceTd"><pre>持久代（perm gen）初始大小为128M</pre></td></tr><tr role="row"><td class="confluenceTd"><pre>-XX:CMSInitiatingPermOccupancyFraction=70</pre></td><td class="confluenceTd"><pre>持久代使用率超过70%触发GC</pre></td></tr></tbody></table></div><p><span style="color: rgb(255,0,0);">上面两个参数表明当持久代使用达到89.6M时，会出发GC，与现场情况一致。发生GC后持久代扩容。</span></p><p>观察另外两个应用：</p><p>housemoving-book-service jvm配置与齿科预订一样，但应用稳定后持久代使用维持在78.5M，</p><p>search-tohome-service持久代使用稳定在100.7M，而其CMSInitiatingPermOccupancyFraction配置为80（100.7 &lt; 128*0.8=102.4）。</p><p>这两个应用均没有发生GC现象。</p><h1 id="CMSGC问题探究-三、解决">三、解决</h1><p>联系运维将CMSInitiatingPermOccupancyFraction调整为80，重启后持久代使用逐渐上升，最终稳定在91.9M。持久代容量128M，没有扩容。</p><p>cat上没有显示发生GC。</p><h1 id="CMSGC问题探究-四、问题与思考">四、问题与思考&nbsp;</h1><h2 id="CMSGC问题探究-1.为什么CMSGC在Cat上显示为FullGC？">1.为什么CMS GC在Cat上显示为Full GC？</h2><p>在cat源码的JvmInfoCollector中，使用java.lang.management.GarbageCollectorMXBean获取GC信息：</p><p><span class="confluence-embedded-file-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image" width="700" src="./CMS GC问题探究_files/image2017-9-15 18-18-45.png" data-image-src="/download/attachments/1079095662/image2017-9-15%2018%3A18%3A45.png?version=1&amp;modificationDate=1505470721000&amp;api=v2" data-unresolved-comment-count="0" data-linked-resource-id="1113019849" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image2017-9-15 18:18:45.png" data-base-url="https://wiki.sankuai.com" data-linked-resource-content-type="image/png" data-linked-resource-container-id="1079095662" data-linked-resource-container-version="90"></span></p><pre>&nbsp;而<span style="color: rgb(0,0,0);">GarbageCollectorMXBean返回的为垃圾收集器的GC信息，CAT将CMS GC作为Full GC记录。</span></pre><div class="code panel pdl conf-macro output-block" style="border-width: 1px;" data-hasbody="true" data-macro-name="code">
                        <div class="codeHeader panelHeader pdl hide-border-bottom">
                            <b class="code-title"> </b>
                            <span class="collapse-source expand-control" style=""><span class="expand-control-icon icon expanded">&nbsp;</span><span class="expand-control-text">折叠原码</span></span>

                        </div>
                        <div class="codeContent panelContent pdl hide-toolbar show-border-top">
                            <div><div id="highlighter_435613" class="syntaxhighlighter sh-rdark  java expanded"><div class="toolbar"><span><a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" class="toolbar_item command_expandSource expandSource">expand source</a></span><span><a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div></td><td class="code"><div class="container" title="Hint: double-click to select code"><div class="line number1 index0 alt2"><code class="java keyword">public</code> <code class="java keyword">interface</code> <code class="java plain">GarbageCollectorMXBean </code><code class="java keyword">extends</code> <code class="java plain">MemoryManagerMXBean {</code></div><div class="line number2 index1 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number3 index2 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* Returns the total number of collections that have occurred.</code></div><div class="line number4 index3 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* This method returns &lt;tt&gt;-1&lt;/tt&gt; if the collection count is undefined for</code></div><div class="line number5 index4 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* this collector.</code></div><div class="line number6 index5 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*</code></div><div class="line number7 index6 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nbsp;</code><code class="java preprocessor">* @return the total number of collections that have occurred.</code></div><div class="line number8 index7 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number9 index8 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java keyword">long</code> <code class="java plain">getCollectionCount();</code></div><div class="line number10 index9 alt1">&nbsp;</div><div class="line number11 index10 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number12 index11 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* Returns the approximate accumulated collection elapsed time</code></div><div class="line number13 index12 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* in milliseconds.&nbsp; This method returns &lt;tt&gt;-1&lt;/tt&gt; if the collection</code></div><div class="line number14 index13 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* elapsed time is undefined for this collector.</code></div><div class="line number15 index14 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* &lt;p&gt;</code></div><div class="line number16 index15 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* The Java virtual machine implementation may use a high resolution</code></div><div class="line number17 index16 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* timer to measure the elapsed time.&nbsp; This method may return the</code></div><div class="line number18 index17 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* same value even if the collection count has been incremented</code></div><div class="line number19 index18 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* if the collection elapsed time is very short.</code></div><div class="line number20 index19 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*</code></div><div class="line number21 index20 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* @return the approximate accumulated collection elapsed time</code></div><div class="line number22 index21 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* in milliseconds.</code></div><div class="line number23 index22 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number24 index23 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java keyword">long</code> <code class="java plain">getCollectionTime();</code></div><div class="line number25 index24 alt2">&nbsp;</div><div class="line number26 index25 alt1"><code class="java plain">}</code></div></div></td></tr></tbody></table></div></div>
                        </div>
                    </div><h2 id="CMSGC问题探究-2.CMSGC和FullGC有什么区别？">2.CMS GC和Full GC有什么区别？</h2><p>在回答这个问题前，先弄清楚Minor GC、Major GC、Full GC的含义。</p><ul><li>Minor GC：新生代的GC</li><li>Major GC：老年代的GC</li><li>Full GC：整个堆，包含新生代、老年代和持久代的GC</li></ul><p>在实际使用中，并不会关心上述三者的定义，更关心应用是否发生了stop the world。</p><p>在stop the world模式中，应用线程在GC开始时停止运行，直到GC结束后才继续运行和处理外部请求。Minor GC通常不会导致长时间的停顿，而Full GC或压缩式垃圾收集，即便不频繁，也会导致长时间的停顿，特别是Java堆比较大的时候。CMS管理新生代的方式与Parallel收集器和Serial收集器相同，而在老年代尽可能并发地执行，每个GC周期有两次停顿（初始标记和重新标记阶段）。</p><p>&nbsp;</p><p>在CMS算法中同时实现了CMS GC和Full GC（参考[4]）：</p><ul><li>CMS GC通过一个后台线程触发，每隔2s判断老年代内存使用率是否达到阈值，如果是则触发一次CMS GC，在该过程中标记出存活对象，然后清除死亡对象，期间会产生碎片空间。</li><li>Full GC通过VM thread执行，整个过程stop the world，过程中判断当前GC是否需要压缩。</li></ul><p>&nbsp;</p><h2 id="CMSGC问题探究-3.什么情况下触发CMSGC？">3.什么情况下触发CMS GC？</h2><p>&nbsp;在HotSpot的源码ConcurrentMarkSweepThread类实现中，run方法包含：</p><p><span class="confluence-embedded-file-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image" width="500" src="./CMS GC问题探究_files/image2017-9-19 11-34-21.png" data-image-src="/download/attachments/1079095662/image2017-9-19%2011%3A34%3A21.png?version=1&amp;modificationDate=1505792054000&amp;api=v2" data-unresolved-comment-count="0" data-linked-resource-id="1115514529" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image2017-9-19 11:34:21.png" data-base-url="https://wiki.sankuai.com" data-linked-resource-content-type="image/png" data-linked-resource-container-id="1079095662" data-linked-resource-container-version="90"></span></p><p><span>sleepBeforeNextCycle的实现如下：</span></p><p><span class="confluence-embedded-file-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image" width="500" src="./CMS GC问题探究_files/image2017-9-18 23-13-32.png" data-image-src="/download/attachments/1079095662/image2017-9-18%2023%3A13%3A32.png?version=1&amp;modificationDate=1505747605000&amp;api=v2" data-unresolved-comment-count="0" data-linked-resource-id="1115510503" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image2017-9-18 23:13:32.png" data-base-url="https://wiki.sankuai.com" data-linked-resource-content-type="image/png" data-linked-resource-container-id="1079095662" data-linked-resource-container-version="90"></span></p><p>&nbsp;其中shouldConcurrentCollect决定是否触发GC：</p><div class="code panel pdl conf-macro output-block" style="border-width: 1px;" data-hasbody="true" data-macro-name="code">
                        <div class="codeHeader panelHeader pdl hide-border-bottom">
                            <b class="code-title"> </b>
                            <span class="collapse-source expand-control" style=""><span class="expand-control-icon icon expanded">&nbsp;</span><span class="expand-control-text">折叠原码</span></span>

                        </div>
                        <div class="codeContent panelContent pdl hide-toolbar show-border-top">
                            <div><div id="highlighter_727824" class="syntaxhighlighter sh-rdark  cpp expanded"><div class="toolbar"><span><a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" class="toolbar_item command_expandSource expandSource">expand source</a></span><span><a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div><div class="line number29 index28 alt2">29</div><div class="line number30 index29 alt1">30</div><div class="line number31 index30 alt2">31</div><div class="line number32 index31 alt1">32</div><div class="line number33 index32 alt2">33</div><div class="line number34 index33 alt1">34</div><div class="line number35 index34 alt2">35</div><div class="line number36 index35 alt1">36</div><div class="line number37 index36 alt2">37</div><div class="line number38 index37 alt1">38</div><div class="line number39 index38 alt2">39</div><div class="line number40 index39 alt1">40</div><div class="line number41 index40 alt2">41</div><div class="line number42 index41 alt1">42</div><div class="line number43 index42 alt2">43</div><div class="line number44 index43 alt1">44</div><div class="line number45 index44 alt2">45</div><div class="line number46 index45 alt1">46</div><div class="line number47 index46 alt2">47</div><div class="line number48 index47 alt1">48</div><div class="line number49 index48 alt2">49</div><div class="line number50 index49 alt1">50</div><div class="line number51 index50 alt2">51</div><div class="line number52 index51 alt1">52</div><div class="line number53 index52 alt2">53</div><div class="line number54 index53 alt1">54</div><div class="line number55 index54 alt2">55</div><div class="line number56 index55 alt1">56</div><div class="line number57 index56 alt2">57</div><div class="line number58 index57 alt1">58</div><div class="line number59 index58 alt2">59</div><div class="line number60 index59 alt1">60</div><div class="line number61 index60 alt2">61</div><div class="line number62 index61 alt1">62</div><div class="line number63 index62 alt2">63</div><div class="line number64 index63 alt1">64</div><div class="line number65 index64 alt2">65</div><div class="line number66 index65 alt1">66</div><div class="line number67 index66 alt2">67</div><div class="line number68 index67 alt1">68</div><div class="line number69 index68 alt2">69</div><div class="line number70 index69 alt1">70</div><div class="line number71 index70 alt2">71</div><div class="line number72 index71 alt1">72</div><div class="line number73 index72 alt2">73</div><div class="line number74 index73 alt1">74</div><div class="line number75 index74 alt2">75</div><div class="line number76 index75 alt1">76</div><div class="line number77 index76 alt2">77</div><div class="line number78 index77 alt1">78</div><div class="line number79 index78 alt2">79</div><div class="line number80 index79 alt1">80</div><div class="line number81 index80 alt2">81</div><div class="line number82 index81 alt1">82</div><div class="line number83 index82 alt2">83</div><div class="line number84 index83 alt1">84</div><div class="line number85 index84 alt2">85</div><div class="line number86 index85 alt1">86</div><div class="line number87 index86 alt2">87</div><div class="line number88 index87 alt1">88</div><div class="line number89 index88 alt2">89</div><div class="line number90 index89 alt1">90</div><div class="line number91 index90 alt2">91</div><div class="line number92 index91 alt1">92</div><div class="line number93 index92 alt2">93</div><div class="line number94 index93 alt1">94</div><div class="line number95 index94 alt2">95</div><div class="line number96 index95 alt1">96</div><div class="line number97 index96 alt2">97</div><div class="line number98 index97 alt1">98</div><div class="line number99 index98 alt2">99</div><div class="line number100 index99 alt1">100</div><div class="line number101 index100 alt2">101</div><div class="line number102 index101 alt1">102</div><div class="line number103 index102 alt2">103</div><div class="line number104 index103 alt1">104</div><div class="line number105 index104 alt2">105</div><div class="line number106 index105 alt1">106</div></td><td class="code"><div class="container" title="Hint: double-click to select code"><div class="line number1 index0 alt2"><code class="cpp color1 bold">bool</code> <code class="cpp plain">CMSCollector::shouldConcurrentCollect() {</code></div><div class="line number2 index1 alt1"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(_full_gc_requested) {</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(Verbose &amp;&amp; PrintGCDetails) {</code></div><div class="line number4 index3 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">gclog_or_tty-&gt;print_cr(</code><code class="cpp string">"CMSCollector: collect because of explicit "</code></div><div class="line number5 index4 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp string">" gc request (or gc_locker)"</code><code class="cpp plain">);</code></div><div class="line number6 index5 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number7 index6 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp keyword bold">true</code><code class="cpp plain">;</code></div><div class="line number8 index7 alt1"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number9 index8 alt2">&nbsp;</div><div class="line number10 index9 alt1"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp comments">// For debugging purposes, change the type of collection.</code></div><div class="line number11 index10 alt2"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp comments">// If the rotation is not on the concurrent collection</code></div><div class="line number12 index11 alt1"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp comments">// type, don't start a concurrent collection.</code></div><div class="line number13 index12 alt2"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp plain">NOT_PRODUCT(</code></div><div class="line number14 index13 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(RotateCMSCollectionTypes &amp;&amp;</code></div><div class="line number15 index14 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">(_cmsGen-&gt;debug_collection_type() !=</code></div><div class="line number16 index15 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">ConcurrentMarkSweepGeneration::Concurrent_collection_type)) {</code></div><div class="line number17 index16 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp functions bold">assert</code><code class="cpp plain">(_cmsGen-&gt;debug_collection_type() !=</code></div><div class="line number18 index17 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">ConcurrentMarkSweepGeneration::Unknown_collection_type,</code></div><div class="line number19 index18 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp string">"Bad cms collection type"</code><code class="cpp plain">);</code></div><div class="line number20 index19 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp keyword bold">false</code><code class="cpp plain">;</code></div><div class="line number21 index20 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number22 index21 alt1"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp plain">)</code></div><div class="line number23 index22 alt2">&nbsp;</div><div class="line number24 index23 alt1"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp plain">FreelistLocker x(</code><code class="cpp keyword bold">this</code><code class="cpp plain">);</code></div><div class="line number25 index24 alt2"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp comments">// ------------------------------------------------------------------</code></div><div class="line number26 index25 alt1"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp comments">// Print out lots of information which affects the initiation of</code></div><div class="line number27 index26 alt2"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp comments">// a collection.</code></div><div class="line number28 index27 alt1"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(PrintCMSInitiationStatistics &amp;&amp; stats().valid()) {</code></div><div class="line number29 index28 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">gclog_or_tty-&gt;print(</code><code class="cpp string">"CMSCollector shouldConcurrentCollect: "</code><code class="cpp plain">);</code></div><div class="line number30 index29 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">gclog_or_tty-&gt;stamp();</code></div><div class="line number31 index30 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">gclog_or_tty-&gt;print_cr(</code><code class="cpp string">""</code><code class="cpp plain">);</code></div><div class="line number32 index31 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">stats().print_on(gclog_or_tty);</code></div><div class="line number33 index32 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">gclog_or_tty-&gt;print_cr(</code><code class="cpp string">"time_until_cms_gen_full %3.7f"</code><code class="cpp plain">,</code></div><div class="line number34 index33 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">stats().time_until_cms_gen_full());</code></div><div class="line number35 index34 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">gclog_or_tty-&gt;print_cr(</code><code class="cpp string">"free="</code><code class="cpp plain">SIZE_FORMAT, _cmsGen-&gt;</code><code class="cpp functions bold">free</code><code class="cpp plain">());</code></div><div class="line number36 index35 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">gclog_or_tty-&gt;print_cr(</code><code class="cpp string">"contiguous_available="</code><code class="cpp plain">SIZE_FORMAT,</code></div><div class="line number37 index36 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">_cmsGen-&gt;contiguous_available());</code></div><div class="line number38 index37 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">gclog_or_tty-&gt;print_cr(</code><code class="cpp string">"promotion_rate=%g"</code><code class="cpp plain">, stats().promotion_rate());</code></div><div class="line number39 index38 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">gclog_or_tty-&gt;print_cr(</code><code class="cpp string">"cms_allocation_rate=%g"</code><code class="cpp plain">, stats().cms_allocation_rate());</code></div><div class="line number40 index39 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">gclog_or_tty-&gt;print_cr(</code><code class="cpp string">"occupancy=%3.7f"</code><code class="cpp plain">, _cmsGen-&gt;occupancy());</code></div><div class="line number41 index40 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">gclog_or_tty-&gt;print_cr(</code><code class="cpp string">"initiatingOccupancy=%3.7f"</code><code class="cpp plain">, _cmsGen-&gt;initiating_occupancy());</code></div><div class="line number42 index41 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">gclog_or_tty-&gt;print_cr(</code><code class="cpp string">"initiatingPermOccupancy=%3.7f"</code><code class="cpp plain">, _permGen-&gt;initiating_occupancy());</code></div><div class="line number43 index42 alt2"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number44 index43 alt1"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp comments">// ------------------------------------------------------------------</code></div><div class="line number45 index44 alt2">&nbsp;</div><div class="line number46 index45 alt1"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp comments">// If the estimated time to complete a cms collection (cms_duration())</code></div><div class="line number47 index46 alt2"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp comments">// is less than the estimated time remaining until the cms generation</code></div><div class="line number48 index47 alt1"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp comments">// is full, start a collection.</code></div><div class="line number49 index48 alt2"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(!UseCMSInitiatingOccupancyOnly) {</code></div><div class="line number50 index49 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(stats().valid()) {</code></div><div class="line number51 index50 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(stats().time_until_cms_start() == 0.0) {</code></div><div class="line number52 index51 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp keyword bold">true</code><code class="cpp plain">;</code></div><div class="line number53 index52 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number54 index53 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">} </code><code class="cpp keyword bold">else</code> <code class="cpp plain">{</code></div><div class="line number55 index54 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">// We want to conservatively collect somewhat early in order</code></div><div class="line number56 index55 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">// to try and "bootstrap" our CMS/promotion statistics;</code></div><div class="line number57 index56 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">// this branch will not fire after the first successful CMS</code></div><div class="line number58 index57 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">// collection because the stats should then be valid.</code></div><div class="line number59 index58 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(_cmsGen-&gt;occupancy() &gt;= _bootstrap_occupancy) {</code></div><div class="line number60 index59 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(Verbose &amp;&amp; PrintGCDetails) {</code></div><div class="line number61 index60 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">gclog_or_tty-&gt;print_cr(</code></div><div class="line number62 index61 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp string">" CMSCollector: collect for bootstrapping statistics:"</code></div><div class="line number63 index62 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp string">" occupancy = %f, boot occupancy = %f"</code><code class="cpp plain">, _cmsGen-&gt;occupancy(),</code></div><div class="line number64 index63 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">_bootstrap_occupancy);</code></div><div class="line number65 index64 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number66 index65 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp keyword bold">true</code><code class="cpp plain">;</code></div><div class="line number67 index66 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number68 index67 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number69 index68 alt2"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number70 index69 alt1">&nbsp;</div><div class="line number71 index70 alt2"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp comments">// Otherwise, we start a collection cycle if either the perm gen or</code></div><div class="line number72 index71 alt1"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp comments">// old gen want a collection cycle started. Each may use</code></div><div class="line number73 index72 alt2"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp comments">// an appropriate criterion for making this decision.</code></div><div class="line number74 index73 alt1"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp comments">// XXX We need to make sure that the gen expansion</code></div><div class="line number75 index74 alt2"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp comments">// criterion dovetails well with this. XXX NEED TO FIX THIS</code></div><div class="line number76 index75 alt1"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(_cmsGen-&gt;should_concurrent_collect()) {</code></div><div class="line number77 index76 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(Verbose &amp;&amp; PrintGCDetails) {</code></div><div class="line number78 index77 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">gclog_or_tty-&gt;print_cr(</code><code class="cpp string">"CMS old gen initiated"</code><code class="cpp plain">);</code></div><div class="line number79 index78 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number80 index79 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp keyword bold">true</code><code class="cpp plain">;</code></div><div class="line number81 index80 alt2"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number82 index81 alt1">&nbsp;</div><div class="line number83 index82 alt2"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp comments">// We start a collection if we believe an incremental collection may fail;</code></div><div class="line number84 index83 alt1"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp comments">// this is not likely to be productive in practice because it's probably too</code></div><div class="line number85 index84 alt2"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp comments">// late anyway.</code></div><div class="line number86 index85 alt1"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp plain">GenCollectedHeap* gch = GenCollectedHeap::heap();</code></div><div class="line number87 index86 alt2"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp functions bold">assert</code><code class="cpp plain">(gch-&gt;collector_policy()-&gt;is_two_generation_policy(),</code></div><div class="line number88 index87 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp string">"You may want to check the correctness of the following"</code><code class="cpp plain">);</code></div><div class="line number89 index88 alt2"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(gch-&gt;incremental_collection_will_fail(</code><code class="cpp keyword bold">true</code> <code class="cpp comments">/* consult_young */</code><code class="cpp plain">)) {</code></div><div class="line number90 index89 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(Verbose &amp;&amp; PrintGCDetails) {</code></div><div class="line number91 index90 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">gclog_or_tty-&gt;print(</code><code class="cpp string">"CMSCollector: collect because incremental collection will fail "</code><code class="cpp plain">);</code></div><div class="line number92 index91 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number93 index92 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp keyword bold">true</code><code class="cpp plain">;</code></div><div class="line number94 index93 alt1"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number95 index94 alt2">&nbsp;</div><div class="line number96 index95 alt1"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(CMSClassUnloadingEnabled &amp;&amp; _permGen-&gt;should_concurrent_collect()) {</code></div><div class="line number97 index96 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">bool</code> <code class="cpp plain">res = update_should_unload_classes();</code></div><div class="line number98 index97 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(res) {</code></div><div class="line number99 index98 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(Verbose &amp;&amp; PrintGCDetails) {</code></div><div class="line number100 index99 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">gclog_or_tty-&gt;print_cr(</code><code class="cpp string">"CMS perm gen initiated"</code><code class="cpp plain">);</code></div><div class="line number101 index100 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number102 index101 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp keyword bold">true</code><code class="cpp plain">;</code></div><div class="line number103 index102 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number104 index103 alt1"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number105 index104 alt2"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp keyword bold">false</code><code class="cpp plain">;</code></div><div class="line number106 index105 alt1"><code class="cpp plain">}</code></div></div></td></tr></tbody></table></div></div>
                        </div>
                    </div><p>&nbsp;</p><p>shouldConcurrentCollect方法中定义的触发CMS GC情况有（本文分析的为jdk1.7，在1.8中持久代被移除，方法区被移至metaspace，因此两个版本触发CMS GC的条件略有不同）：</p><ul><li><p><span>（2~8）_full_gc_requested为true，请求一次Full GC，例如调用System.gc()。</span></p></li><li><p><span>（49~69）如果没有设置</span>UseCMSInitiatingOccupancyOnly，动态计算老年代使用是否达到阈值。如果预计完成GC的时间小于预计老年代填满的时间，则进行一次回收。</p></li><li><p>（76~81）老年代should_concurrent_collect为true，以下详述。</p></li><li>（89~94）预计增量回收失败时。</li><li>（96~104）CMS默认不对持久代进行GC。当配置了CMSClassUnloadingEnabled，并且持久代使用率达到一定阈值时触发GC。</li></ul><p>老年代的should_concurrent_collect方法如下：</p><div class="code panel pdl conf-macro output-block" style="border-width: 1px;" data-hasbody="true" data-macro-name="code">
                        <div class="codeHeader panelHeader pdl hide-border-bottom">
                            <b class="code-title"> </b>
                            <span class="collapse-source expand-control" style=""><span class="expand-control-icon icon expanded">&nbsp;</span><span class="expand-control-text">折叠原码</span></span>

                        </div>
                        <div class="codeContent panelContent pdl hide-toolbar show-border-top">
                            <div><div id="highlighter_535627" class="syntaxhighlighter sh-rdark  cpp expanded"><div class="toolbar"><span><a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" class="toolbar_item command_expandSource expandSource">expand source</a></span><span><a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div><div class="line number29 index28 alt2">29</div><div class="line number30 index29 alt1">30</div><div class="line number31 index30 alt2">31</div><div class="line number32 index31 alt1">32</div><div class="line number33 index32 alt2">33</div><div class="line number34 index33 alt1">34</div><div class="line number35 index34 alt2">35</div><div class="line number36 index35 alt1">36</div><div class="line number37 index36 alt2">37</div><div class="line number38 index37 alt1">38</div><div class="line number39 index38 alt2">39</div><div class="line number40 index39 alt1">40</div><div class="line number41 index40 alt2">41</div><div class="line number42 index41 alt1">42</div><div class="line number43 index42 alt2">43</div><div class="line number44 index43 alt1">44</div><div class="line number45 index44 alt2">45</div><div class="line number46 index45 alt1">46</div><div class="line number47 index46 alt2">47</div><div class="line number48 index47 alt1">48</div><div class="line number49 index48 alt2">49</div><div class="line number50 index49 alt1">50</div><div class="line number51 index50 alt2">51</div><div class="line number52 index51 alt1">52</div></td><td class="code"><div class="container" title="Hint: double-click to select code"><div class="line number1 index0 alt2"><code class="cpp comments">// We should be conservative in starting a collection cycle.&nbsp; To</code></div><div class="line number2 index1 alt1"><code class="cpp comments">// start too eagerly runs the risk of collecting too often in the</code></div><div class="line number3 index2 alt2"><code class="cpp comments">// extreme.&nbsp; To collect too rarely falls back on full collections,</code></div><div class="line number4 index3 alt1"><code class="cpp comments">// which works, even if not optimum in terms of concurrent work.</code></div><div class="line number5 index4 alt2"><code class="cpp comments">// As a work around for too eagerly collecting, use the flag</code></div><div class="line number6 index5 alt1"><code class="cpp comments">// UseCMSInitiatingOccupancyOnly.&nbsp; This also has the advantage of</code></div><div class="line number7 index6 alt2"><code class="cpp comments">// giving the user an easily understandable way of controlling the</code></div><div class="line number8 index7 alt1"><code class="cpp comments">// collections.</code></div><div class="line number9 index8 alt2"><code class="cpp comments">// We want to start a new collection cycle if any of the following</code></div><div class="line number10 index9 alt1"><code class="cpp comments">// conditions hold:</code></div><div class="line number11 index10 alt2"><code class="cpp comments">// . our current occupancy exceeds the configured initiating occupancy</code></div><div class="line number12 index11 alt1"><code class="cpp comments">//&nbsp;&nbsp; for this generation, or</code></div><div class="line number13 index12 alt2"><code class="cpp comments">// . we recently needed to expand this space and have not, since that</code></div><div class="line number14 index13 alt1"><code class="cpp comments">//&nbsp;&nbsp; expansion, done a collection of this generation, or</code></div><div class="line number15 index14 alt2"><code class="cpp comments">// . the underlying space believes that it may be a good idea to initiate</code></div><div class="line number16 index15 alt1"><code class="cpp comments">//&nbsp;&nbsp; a concurrent collection (this may be based on criteria such as the</code></div><div class="line number17 index16 alt2"><code class="cpp comments">//&nbsp;&nbsp; following: the space uses linear allocation and linear allocation is</code></div><div class="line number18 index17 alt1"><code class="cpp comments">//&nbsp;&nbsp; going to fail, or there is believed to be excessive fragmentation in</code></div><div class="line number19 index18 alt2"><code class="cpp comments">//&nbsp;&nbsp; the generation, etc... or ...</code></div><div class="line number20 index19 alt1"><code class="cpp comments">// [.(currently done by CMSCollector::shouldConcurrentCollect() only for</code></div><div class="line number21 index20 alt2"><code class="cpp comments">//&nbsp;&nbsp; the case of the old generation, not the perm generation; see CR 6543076):</code></div><div class="line number22 index21 alt1"><code class="cpp comments">//&nbsp;&nbsp; we may be approaching a point at which allocation requests may fail because</code></div><div class="line number23 index22 alt2"><code class="cpp comments">//&nbsp;&nbsp; we will be out of sufficient free space given allocation rate estimates.]</code></div><div class="line number24 index23 alt1"><code class="cpp color1 bold">bool</code> <code class="cpp plain">ConcurrentMarkSweepGeneration::should_concurrent_collect() </code><code class="cpp keyword bold">const</code> <code class="cpp plain">{</code></div><div class="line number25 index24 alt2">&nbsp;</div><div class="line number26 index25 alt1"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp plain">assert_lock_strong(freelistLock());</code></div><div class="line number27 index26 alt2"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(occupancy() &gt; initiating_occupancy()) {</code></div><div class="line number28 index27 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(PrintGCDetails &amp;&amp; Verbose) {</code></div><div class="line number29 index28 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">gclog_or_tty-&gt;print(</code><code class="cpp string">" %s: collect because of occupancy %f / %f&nbsp; "</code><code class="cpp plain">,</code></div><div class="line number30 index29 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">short_name(), occupancy(), initiating_occupancy());</code></div><div class="line number31 index30 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number32 index31 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp keyword bold">true</code><code class="cpp plain">;</code></div><div class="line number33 index32 alt2"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number34 index33 alt1"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(UseCMSInitiatingOccupancyOnly) {</code></div><div class="line number35 index34 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp keyword bold">false</code><code class="cpp plain">;</code></div><div class="line number36 index35 alt1"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number37 index36 alt2"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(expansion_cause() == CMSExpansionCause::_satisfy_allocation) {</code></div><div class="line number38 index37 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(PrintGCDetails &amp;&amp; Verbose) {</code></div><div class="line number39 index38 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">gclog_or_tty-&gt;print(</code><code class="cpp string">" %s: collect because expanded for allocation "</code><code class="cpp plain">,</code></div><div class="line number40 index39 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">short_name());</code></div><div class="line number41 index40 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number42 index41 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp keyword bold">true</code><code class="cpp plain">;</code></div><div class="line number43 index42 alt2"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number44 index43 alt1"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(_cmsSpace-&gt;should_concurrent_collect()) {</code></div><div class="line number45 index44 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(PrintGCDetails &amp;&amp; Verbose) {</code></div><div class="line number46 index45 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">gclog_or_tty-&gt;print(</code><code class="cpp string">" %s: collect because cmsSpace says so "</code><code class="cpp plain">,</code></div><div class="line number47 index46 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">short_name());</code></div><div class="line number48 index47 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number49 index48 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp keyword bold">true</code><code class="cpp plain">;</code></div><div class="line number50 index49 alt1"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number51 index50 alt2"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp keyword bold">false</code><code class="cpp plain">;</code></div><div class="line number52 index51 alt1"><code class="cpp plain">}</code></div></div></td></tr></tbody></table></div></div>
                        </div>
                    </div><p>以下情况时发生GC：</p><ul><li>（27~33）堆使用率达到initiating_occupancy，即配置的<span>CMSInitiatingOccupancyFraction值。</span></li><li><span><span>（34~36）当</span></span>UseCMSInitiatingOccupancyOnly为true时，仅堆使用率达到阈值时才回收，不判断其他条件。</li><li>（37~43）当堆因为_satisfy_allocation而扩容时。</li><li><p><span>（44~50）_cmsSpace（</span>CompactibleFreeListSpace）需要回收时。</p></li></ul><p>&nbsp;</p><p>综上所述，触发CMS GC的条件有：</p><ul><li>请求Full GC，例如System.gc。</li><li>如果没有设置UseCMSInitiatingOccupancyOnly，动态计算老年代使用是否达到阈值。如果预计完成GC的时间小于预计老年代填满的时间，则进行一次回收。</li><li>当：<ul><li>堆使用率达到initiating_occupancy，即配置的CMSInitiatingOccupancyFraction值</li><li>当UseCMSInitiatingOccupancyOnly为true时，仅堆使用率达到阈值时才回收，不判断其他条件</li><li>当堆因为_satisfy_allocation而扩容</li><li>CompactibleFreeListSpace需要回收时</li></ul></li><li>预计增量回收失败时。</li><li>配置了CMSClassUnloadingEnabled，并且持久代使用率达到一定阈值时。</li></ul><p>当达到这些条件时，执行CMS GC，对应于collect_in_background方法。</p><h2 id="CMSGC问题探究-4.什么情况下触发FullGC？">4.什么情况下触发Full GC？</h2><p>CMS中GC分为background和foreground。background对应于collect_in_background方法，为上述的CMS GC，而foreground对应于collect_in_foreground，即为Full GC。</p><pre>&nbsp;</pre><h1 id="CMSGC问题探究-五、小贴士">五、小贴士</h1><ul><li><p>使用Clion（JetBrains系列，进行C++开发的IDE）导入hotspot源码时需要在CmakeLists.txt中使用include_directories指定头文件目录，例如</p><p>include_directories( "~/jdk7u-hotspot/src/share/vm","~/jdk7u-hotspot/src/share/vm/precompiled")</p></li></ul><h1 id="CMSGC问题探究-六、参考">六、参考</h1><p><strong>源码</strong></p><ul><li><a href="https://github.com/openjdk-mirror/jdk7u-hotspot" class="external-link" rel="nofollow">HotSpot源码</a></li></ul><p><strong>博客</strong></p><ul><li>[1]&nbsp;<a href="http://www.cnblogs.com/redcreen/archive/2011/05/04/2037057.html" class="external-link" rel="nofollow">JVM参数详解</a></li><li>[2]&nbsp;<a href="http://colobu.com/2015/04/07/minor-gc-vs-major-gc-vs-full-gc/" class="external-link" rel="nofollow">JVM 垃圾回收 Minor gc vs Major gc vs Full gc</a></li><li>[3]&nbsp;<a href="http://ifeve.com/jvm-cms-log/" class="external-link" rel="nofollow">了解CMS垃圾回收日志</a></li><li>[4]&nbsp;<a href="http://www.jianshu.com/p/55670407fdb9" class="external-link" rel="nofollow">关于CMS垃圾收集算法的一些疑惑</a>（严重参考）</li><li>[5]&nbsp;<a href="http://blog.csdn.net/FoolishAndStupid/article/details/77430875" class="external-link" rel="nofollow">JVM源码阅读笔记[1]：如何触发一次CMS回收</a></li></ul><p><strong>书籍</strong></p><ul><li>Java性能优化权威指南</li><li>深入理解Java虚拟机</li></ul><pre>&nbsp;</pre><h1 id="CMSGC问题探究-七、附录">七、附录</h1><h2 id="CMSGC问题探究-1.CMSGC源码">1.CMS GC源码</h2><div class="code panel pdl conf-macro output-block" style="border-width: 1px;" data-hasbody="true" data-macro-name="code">
                        <div class="codeHeader panelHeader pdl hide-border-bottom">
                            <b class="code-title"> </b>
                            <span class="collapse-source expand-control" style=""><span class="expand-control-icon icon expanded">&nbsp;</span><span class="expand-control-text">折叠原码</span></span>

                        </div>
                        <div class="codeContent panelContent pdl hide-toolbar show-border-top">
                            <div><div id="highlighter_89893" class="syntaxhighlighter sh-rdark  cpp expanded"><div class="toolbar"><span><a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" class="toolbar_item command_expandSource expandSource">expand source</a></span><span><a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div><div class="line number29 index28 alt2">29</div><div class="line number30 index29 alt1">30</div><div class="line number31 index30 alt2">31</div><div class="line number32 index31 alt1">32</div><div class="line number33 index32 alt2">33</div><div class="line number34 index33 alt1">34</div><div class="line number35 index34 alt2">35</div><div class="line number36 index35 alt1">36</div><div class="line number37 index36 alt2">37</div><div class="line number38 index37 alt1">38</div><div class="line number39 index38 alt2">39</div><div class="line number40 index39 alt1">40</div><div class="line number41 index40 alt2">41</div><div class="line number42 index41 alt1">42</div><div class="line number43 index42 alt2">43</div><div class="line number44 index43 alt1">44</div><div class="line number45 index44 alt2">45</div><div class="line number46 index45 alt1">46</div><div class="line number47 index46 alt2">47</div><div class="line number48 index47 alt1">48</div><div class="line number49 index48 alt2">49</div><div class="line number50 index49 alt1">50</div><div class="line number51 index50 alt2">51</div><div class="line number52 index51 alt1">52</div><div class="line number53 index52 alt2">53</div><div class="line number54 index53 alt1">54</div><div class="line number55 index54 alt2">55</div><div class="line number56 index55 alt1">56</div><div class="line number57 index56 alt2">57</div><div class="line number58 index57 alt1">58</div><div class="line number59 index58 alt2">59</div><div class="line number60 index59 alt1">60</div><div class="line number61 index60 alt2">61</div><div class="line number62 index61 alt1">62</div><div class="line number63 index62 alt2">63</div><div class="line number64 index63 alt1">64</div><div class="line number65 index64 alt2">65</div><div class="line number66 index65 alt1">66</div><div class="line number67 index66 alt2">67</div><div class="line number68 index67 alt1">68</div><div class="line number69 index68 alt2">69</div><div class="line number70 index69 alt1">70</div><div class="line number71 index70 alt2">71</div><div class="line number72 index71 alt1">72</div><div class="line number73 index72 alt2">73</div><div class="line number74 index73 alt1">74</div><div class="line number75 index74 alt2">75</div><div class="line number76 index75 alt1">76</div><div class="line number77 index76 alt2">77</div><div class="line number78 index77 alt1">78</div><div class="line number79 index78 alt2">79</div><div class="line number80 index79 alt1">80</div><div class="line number81 index80 alt2">81</div><div class="line number82 index81 alt1">82</div><div class="line number83 index82 alt2">83</div><div class="line number84 index83 alt1">84</div><div class="line number85 index84 alt2">85</div><div class="line number86 index85 alt1">86</div><div class="line number87 index86 alt2">87</div><div class="line number88 index87 alt1">88</div><div class="line number89 index88 alt2">89</div><div class="line number90 index89 alt1">90</div><div class="line number91 index90 alt2">91</div><div class="line number92 index91 alt1">92</div><div class="line number93 index92 alt2">93</div><div class="line number94 index93 alt1">94</div><div class="line number95 index94 alt2">95</div><div class="line number96 index95 alt1">96</div><div class="line number97 index96 alt2">97</div><div class="line number98 index97 alt1">98</div><div class="line number99 index98 alt2">99</div><div class="line number100 index99 alt1">100</div><div class="line number101 index100 alt2">101</div><div class="line number102 index101 alt1">102</div><div class="line number103 index102 alt2">103</div><div class="line number104 index103 alt1">104</div><div class="line number105 index104 alt2">105</div><div class="line number106 index105 alt1">106</div><div class="line number107 index106 alt2">107</div><div class="line number108 index107 alt1">108</div><div class="line number109 index108 alt2">109</div><div class="line number110 index109 alt1">110</div><div class="line number111 index110 alt2">111</div><div class="line number112 index111 alt1">112</div><div class="line number113 index112 alt2">113</div><div class="line number114 index113 alt1">114</div><div class="line number115 index114 alt2">115</div><div class="line number116 index115 alt1">116</div><div class="line number117 index116 alt2">117</div><div class="line number118 index117 alt1">118</div><div class="line number119 index118 alt2">119</div><div class="line number120 index119 alt1">120</div><div class="line number121 index120 alt2">121</div><div class="line number122 index121 alt1">122</div><div class="line number123 index122 alt2">123</div><div class="line number124 index123 alt1">124</div><div class="line number125 index124 alt2">125</div><div class="line number126 index125 alt1">126</div><div class="line number127 index126 alt2">127</div><div class="line number128 index127 alt1">128</div><div class="line number129 index128 alt2">129</div><div class="line number130 index129 alt1">130</div><div class="line number131 index130 alt2">131</div><div class="line number132 index131 alt1">132</div><div class="line number133 index132 alt2">133</div><div class="line number134 index133 alt1">134</div><div class="line number135 index134 alt2">135</div><div class="line number136 index135 alt1">136</div><div class="line number137 index136 alt2">137</div><div class="line number138 index137 alt1">138</div><div class="line number139 index138 alt2">139</div><div class="line number140 index139 alt1">140</div><div class="line number141 index140 alt2">141</div><div class="line number142 index141 alt1">142</div><div class="line number143 index142 alt2">143</div><div class="line number144 index143 alt1">144</div><div class="line number145 index144 alt2">145</div><div class="line number146 index145 alt1">146</div><div class="line number147 index146 alt2">147</div><div class="line number148 index147 alt1">148</div><div class="line number149 index148 alt2">149</div><div class="line number150 index149 alt1">150</div><div class="line number151 index150 alt2">151</div><div class="line number152 index151 alt1">152</div><div class="line number153 index152 alt2">153</div><div class="line number154 index153 alt1">154</div><div class="line number155 index154 alt2">155</div><div class="line number156 index155 alt1">156</div><div class="line number157 index156 alt2">157</div><div class="line number158 index157 alt1">158</div><div class="line number159 index158 alt2">159</div><div class="line number160 index159 alt1">160</div><div class="line number161 index160 alt2">161</div><div class="line number162 index161 alt1">162</div><div class="line number163 index162 alt2">163</div><div class="line number164 index163 alt1">164</div><div class="line number165 index164 alt2">165</div><div class="line number166 index165 alt1">166</div><div class="line number167 index166 alt2">167</div><div class="line number168 index167 alt1">168</div><div class="line number169 index168 alt2">169</div><div class="line number170 index169 alt1">170</div><div class="line number171 index170 alt2">171</div><div class="line number172 index171 alt1">172</div><div class="line number173 index172 alt2">173</div><div class="line number174 index173 alt1">174</div><div class="line number175 index174 alt2">175</div><div class="line number176 index175 alt1">176</div><div class="line number177 index176 alt2">177</div><div class="line number178 index177 alt1">178</div><div class="line number179 index178 alt2">179</div><div class="line number180 index179 alt1">180</div><div class="line number181 index180 alt2">181</div><div class="line number182 index181 alt1">182</div><div class="line number183 index182 alt2">183</div><div class="line number184 index183 alt1">184</div><div class="line number185 index184 alt2">185</div><div class="line number186 index185 alt1">186</div><div class="line number187 index186 alt2">187</div><div class="line number188 index187 alt1">188</div><div class="line number189 index188 alt2">189</div><div class="line number190 index189 alt1">190</div><div class="line number191 index190 alt2">191</div><div class="line number192 index191 alt1">192</div><div class="line number193 index192 alt2">193</div><div class="line number194 index193 alt1">194</div><div class="line number195 index194 alt2">195</div><div class="line number196 index195 alt1">196</div><div class="line number197 index196 alt2">197</div><div class="line number198 index197 alt1">198</div><div class="line number199 index198 alt2">199</div><div class="line number200 index199 alt1">200</div><div class="line number201 index200 alt2">201</div><div class="line number202 index201 alt1">202</div><div class="line number203 index202 alt2">203</div><div class="line number204 index203 alt1">204</div><div class="line number205 index204 alt2">205</div><div class="line number206 index205 alt1">206</div><div class="line number207 index206 alt2">207</div><div class="line number208 index207 alt1">208</div><div class="line number209 index208 alt2">209</div><div class="line number210 index209 alt1">210</div><div class="line number211 index210 alt2">211</div><div class="line number212 index211 alt1">212</div><div class="line number213 index212 alt2">213</div><div class="line number214 index213 alt1">214</div><div class="line number215 index214 alt2">215</div><div class="line number216 index215 alt1">216</div><div class="line number217 index216 alt2">217</div><div class="line number218 index217 alt1">218</div><div class="line number219 index218 alt2">219</div><div class="line number220 index219 alt1">220</div><div class="line number221 index220 alt2">221</div><div class="line number222 index221 alt1">222</div><div class="line number223 index222 alt2">223</div><div class="line number224 index223 alt1">224</div><div class="line number225 index224 alt2">225</div><div class="line number226 index225 alt1">226</div><div class="line number227 index226 alt2">227</div><div class="line number228 index227 alt1">228</div><div class="line number229 index228 alt2">229</div><div class="line number230 index229 alt1">230</div><div class="line number231 index230 alt2">231</div><div class="line number232 index231 alt1">232</div><div class="line number233 index232 alt2">233</div><div class="line number234 index233 alt1">234</div><div class="line number235 index234 alt2">235</div><div class="line number236 index235 alt1">236</div><div class="line number237 index236 alt2">237</div><div class="line number238 index237 alt1">238</div><div class="line number239 index238 alt2">239</div><div class="line number240 index239 alt1">240</div><div class="line number241 index240 alt2">241</div><div class="line number242 index241 alt1">242</div><div class="line number243 index242 alt2">243</div><div class="line number244 index243 alt1">244</div><div class="line number245 index244 alt2">245</div><div class="line number246 index245 alt1">246</div></td><td class="code"><div class="container" title="Hint: double-click to select code"><div class="line number1 index0 alt2"><code class="cpp comments">// There are separate collect_in_background and collect_in_foreground because of</code></div><div class="line number2 index1 alt1"><code class="cpp comments">// the different locking requirements of the background collector and the</code></div><div class="line number3 index2 alt2"><code class="cpp comments">// foreground collector.&nbsp; There was originally an attempt to share</code></div><div class="line number4 index3 alt1"><code class="cpp comments">// one "collect" method between the background collector and the foreground</code></div><div class="line number5 index4 alt2"><code class="cpp comments">// collector but the if-then-else required made it cleaner to have</code></div><div class="line number6 index5 alt1"><code class="cpp comments">// separate methods.</code></div><div class="line number7 index6 alt2"><code class="cpp keyword bold">void</code> <code class="cpp plain">CMSCollector::collect_in_background(</code><code class="cpp color1 bold">bool</code> <code class="cpp plain">clear_all_soft_refs) {</code></div><div class="line number8 index7 alt1"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp functions bold">assert</code><code class="cpp plain">(Thread::current()-&gt;is_ConcurrentGC_thread(),</code></div><div class="line number9 index8 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp string">"A CMS asynchronous collection is only allowed on a CMS thread."</code><code class="cpp plain">);</code></div><div class="line number10 index9 alt1">&nbsp;</div><div class="line number11 index10 alt2"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp plain">GenCollectedHeap* gch = GenCollectedHeap::heap();</code></div><div class="line number12 index11 alt1"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp plain">{</code></div><div class="line number13 index12 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">bool</code> <code class="cpp plain">safepoint_check = Mutex::_no_safepoint_check_flag;</code></div><div class="line number14 index13 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">MutexLockerEx hl(Heap_lock, safepoint_check);</code></div><div class="line number15 index14 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">FreelistLocker fll(</code><code class="cpp keyword bold">this</code><code class="cpp plain">);</code></div><div class="line number16 index15 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">MutexLockerEx x(CGC_lock, safepoint_check);</code></div><div class="line number17 index16 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(_foregroundGCIsActive || !UseAsyncConcMarkSweepGC) {</code></div><div class="line number18 index17 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">// The foreground collector is active or we're</code></div><div class="line number19 index18 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">// not using asynchronous collections.&nbsp; Skip this</code></div><div class="line number20 index19 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">// background collection.</code></div><div class="line number21 index20 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp functions bold">assert</code><code class="cpp plain">(!_foregroundGCShouldWait, </code><code class="cpp string">"Should be clear"</code><code class="cpp plain">);</code></div><div class="line number22 index21 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code><code class="cpp plain">;</code></div><div class="line number23 index22 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">} </code><code class="cpp keyword bold">else</code> <code class="cpp plain">{</code></div><div class="line number24 index23 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp functions bold">assert</code><code class="cpp plain">(_collectorState == Idling, </code><code class="cpp string">"Should be idling before start."</code><code class="cpp plain">);</code></div><div class="line number25 index24 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">_collectorState = InitialMarking;</code></div><div class="line number26 index25 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">// Reset the expansion cause, now that we are about to begin</code></div><div class="line number27 index26 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">// a new cycle.</code></div><div class="line number28 index27 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">clear_expansion_cause();</code></div><div class="line number29 index28 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number30 index29 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">// Decide if we want to enable class unloading as part of the</code></div><div class="line number31 index30 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">// ensuing concurrent GC cycle.</code></div><div class="line number32 index31 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">update_should_unload_classes();</code></div><div class="line number33 index32 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">_full_gc_requested = </code><code class="cpp keyword bold">false</code><code class="cpp plain">;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="cpp comments">// acks all outstanding full gc requests</code></div><div class="line number34 index33 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">// Signal that we are about to start a collection</code></div><div class="line number35 index34 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">gch-&gt;increment_total_full_collections();&nbsp; </code><code class="cpp comments">// ... starting a collection cycle</code></div><div class="line number36 index35 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">_collection_count_start = gch-&gt;total_full_collections();</code></div><div class="line number37 index36 alt2"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number38 index37 alt1">&nbsp;</div><div class="line number39 index38 alt2"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp comments">// Used for PrintGC</code></div><div class="line number40 index39 alt1"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp color1 bold">size_t</code> <code class="cpp plain">prev_used;</code></div><div class="line number41 index40 alt2"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(PrintGC &amp;&amp; Verbose) {</code></div><div class="line number42 index41 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">prev_used = _cmsGen-&gt;used(); </code><code class="cpp comments">// XXXPERM</code></div><div class="line number43 index42 alt2"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number44 index43 alt1">&nbsp;</div><div class="line number45 index44 alt2"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp comments">// The change of the collection state is normally done at this level;</code></div><div class="line number46 index45 alt1"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp comments">// the exceptions are phases that are executed while the world is</code></div><div class="line number47 index46 alt2"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp comments">// stopped.&nbsp; For those phases the change of state is done while the</code></div><div class="line number48 index47 alt1"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp comments">// world is stopped.&nbsp; For baton passing purposes this allows the</code></div><div class="line number49 index48 alt2"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp comments">// background collector to finish the phase and change state atomically.</code></div><div class="line number50 index49 alt1"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp comments">// The foreground collector cannot wait on a phase that is done</code></div><div class="line number51 index50 alt2"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp comments">// while the world is stopped because the foreground collector already</code></div><div class="line number52 index51 alt1"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp comments">// has the world stopped and would deadlock.</code></div><div class="line number53 index52 alt2"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp keyword bold">while</code> <code class="cpp plain">(_collectorState != Idling) {</code></div><div class="line number54 index53 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(TraceCMSState) {</code></div><div class="line number55 index54 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">gclog_or_tty-&gt;print_cr(</code><code class="cpp string">"Thread "</code> <code class="cpp plain">INTPTR_FORMAT </code><code class="cpp string">" in CMS state %d"</code><code class="cpp plain">,</code></div><div class="line number56 index55 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">Thread::current(), _collectorState);</code></div><div class="line number57 index56 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number58 index57 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">// The foreground collector</code></div><div class="line number59 index58 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">//&nbsp;&nbsp; holds the Heap_lock throughout its collection.</code></div><div class="line number60 index59 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">//&nbsp;&nbsp; holds the CMS token (but not the lock)</code></div><div class="line number61 index60 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">//&nbsp;&nbsp;&nbsp;&nbsp; except while it is waiting for the background collector to yield.</code></div><div class="line number62 index61 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">//</code></div><div class="line number63 index62 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">// The foreground collector should be blocked (not for long)</code></div><div class="line number64 index63 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">//&nbsp;&nbsp; if the background collector is about to start a phase</code></div><div class="line number65 index64 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">//&nbsp;&nbsp; executed with world stopped.&nbsp; If the background</code></div><div class="line number66 index65 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">//&nbsp;&nbsp; collector has already started such a phase, the</code></div><div class="line number67 index66 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">//&nbsp;&nbsp; foreground collector is blocked waiting for the</code></div><div class="line number68 index67 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">//&nbsp;&nbsp; Heap_lock.&nbsp; The stop-world phases (InitialMarking and FinalMarking)</code></div><div class="line number69 index68 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">//&nbsp;&nbsp; are executed in the VM thread.</code></div><div class="line number70 index69 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">//</code></div><div class="line number71 index70 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">// The locking order is</code></div><div class="line number72 index71 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">//&nbsp;&nbsp; PendingListLock (PLL)&nbsp; -- if applicable (FinalMarking)</code></div><div class="line number73 index72 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">//&nbsp;&nbsp; Heap_lock&nbsp; (both this &amp; PLL locked in VM_CMS_Operation::prologue())</code></div><div class="line number74 index73 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">//&nbsp;&nbsp; CMS token&nbsp; (claimed in</code></div><div class="line number75 index74 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; stop_world_and_do() --&gt;</code></div><div class="line number76 index75 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; safepoint_synchronize() --&gt;</code></div><div class="line number77 index76 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CMSThread::synchronize())</code></div><div class="line number78 index77 alt1">&nbsp;</div><div class="line number79 index78 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">{</code></div><div class="line number80 index79 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">// Check if the FG collector wants us to yield.</code></div><div class="line number81 index80 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">CMSTokenSync x(</code><code class="cpp keyword bold">true</code><code class="cpp plain">); </code><code class="cpp comments">// is cms thread</code></div><div class="line number82 index81 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(waitForForegroundGC()) {</code></div><div class="line number83 index82 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">// We yielded to a foreground GC, nothing more to be</code></div><div class="line number84 index83 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">// done this round.</code></div><div class="line number85 index84 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp functions bold">assert</code><code class="cpp plain">(_foregroundGCShouldWait == </code><code class="cpp keyword bold">false</code><code class="cpp plain">, </code><code class="cpp string">"We set it to false in "</code></div><div class="line number86 index85 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp string">"waitForForegroundGC()"</code><code class="cpp plain">);</code></div><div class="line number87 index86 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(TraceCMSState) {</code></div><div class="line number88 index87 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">gclog_or_tty-&gt;print_cr(</code><code class="cpp string">"CMS Thread "</code> <code class="cpp plain">INTPTR_FORMAT</code></div><div class="line number89 index88 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp string">" exiting collection CMS state %d"</code><code class="cpp plain">,</code></div><div class="line number90 index89 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">Thread::current(), _collectorState);</code></div><div class="line number91 index90 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number92 index91 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code><code class="cpp plain">;</code></div><div class="line number93 index92 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">} </code><code class="cpp keyword bold">else</code> <code class="cpp plain">{</code></div><div class="line number94 index93 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">// The background collector can run but check to see if the</code></div><div class="line number95 index94 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">// foreground collector has done a collection while the</code></div><div class="line number96 index95 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">// background collector was waiting to get the CGC_lock</code></div><div class="line number97 index96 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">// above.&nbsp; If yes, break so that _foregroundGCShouldWait</code></div><div class="line number98 index97 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">// is cleared before returning.</code></div><div class="line number99 index98 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(_collectorState == Idling) {</code></div><div class="line number100 index99 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">break</code><code class="cpp plain">;</code></div><div class="line number101 index100 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number102 index101 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number103 index102 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number104 index103 alt1">&nbsp;</div><div class="line number105 index104 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp functions bold">assert</code><code class="cpp plain">(_foregroundGCShouldWait, </code><code class="cpp string">"Foreground collector, if active, "</code></div><div class="line number106 index105 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp string">"should be waiting"</code><code class="cpp plain">);</code></div><div class="line number107 index106 alt2">&nbsp;</div><div class="line number108 index107 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">switch</code> <code class="cpp plain">(_collectorState) {</code></div><div class="line number109 index108 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">case</code> <code class="cpp plain">InitialMarking:</code></div><div class="line number110 index109 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">{</code></div><div class="line number111 index110 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">ReleaseForegroundGC x(</code><code class="cpp keyword bold">this</code><code class="cpp plain">);</code></div><div class="line number112 index111 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">stats().record_cms_begin();</code></div><div class="line number113 index112 alt2">&nbsp;</div><div class="line number114 index113 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">VM_CMS_Initial_Mark initial_mark_op(</code><code class="cpp keyword bold">this</code><code class="cpp plain">);</code></div><div class="line number115 index114 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">VMThread::execute(&amp;initial_mark_op);</code></div><div class="line number116 index115 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number117 index116 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">// The collector state may be any legal state at this point</code></div><div class="line number118 index117 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">// since the background collector may have yielded to the</code></div><div class="line number119 index118 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">// foreground collector.</code></div><div class="line number120 index119 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">break</code><code class="cpp plain">;</code></div><div class="line number121 index120 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">case</code> <code class="cpp plain">Marking:</code></div><div class="line number122 index121 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">// initial marking in checkpointRootsInitialWork has been completed</code></div><div class="line number123 index122 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(markFromRoots(</code><code class="cpp keyword bold">true</code><code class="cpp plain">)) { </code><code class="cpp comments">// we were successful</code></div><div class="line number124 index123 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp functions bold">assert</code><code class="cpp plain">(_collectorState == Precleaning, </code><code class="cpp string">"Collector state should "</code></div><div class="line number125 index124 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp string">"have changed"</code><code class="cpp plain">);</code></div><div class="line number126 index125 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">} </code><code class="cpp keyword bold">else</code> <code class="cpp plain">{</code></div><div class="line number127 index126 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp functions bold">assert</code><code class="cpp plain">(_foregroundGCIsActive, </code><code class="cpp string">"Internal state inconsistency"</code><code class="cpp plain">);</code></div><div class="line number128 index127 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number129 index128 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">break</code><code class="cpp plain">;</code></div><div class="line number130 index129 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">case</code> <code class="cpp plain">Precleaning:</code></div><div class="line number131 index130 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(UseAdaptiveSizePolicy) {</code></div><div class="line number132 index131 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">size_policy()-&gt;concurrent_precleaning_begin();</code></div><div class="line number133 index132 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number134 index133 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">// marking from roots in markFromRoots has been completed</code></div><div class="line number135 index134 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">preclean();</code></div><div class="line number136 index135 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(UseAdaptiveSizePolicy) {</code></div><div class="line number137 index136 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">size_policy()-&gt;concurrent_precleaning_end();</code></div><div class="line number138 index137 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number139 index138 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp functions bold">assert</code><code class="cpp plain">(_collectorState == AbortablePreclean ||</code></div><div class="line number140 index139 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">_collectorState == FinalMarking,</code></div><div class="line number141 index140 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp string">"Collector state should have changed"</code><code class="cpp plain">);</code></div><div class="line number142 index141 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">break</code><code class="cpp plain">;</code></div><div class="line number143 index142 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">case</code> <code class="cpp plain">AbortablePreclean:</code></div><div class="line number144 index143 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(UseAdaptiveSizePolicy) {</code></div><div class="line number145 index144 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">size_policy()-&gt;concurrent_phases_resume();</code></div><div class="line number146 index145 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number147 index146 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">abortable_preclean();</code></div><div class="line number148 index147 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(UseAdaptiveSizePolicy) {</code></div><div class="line number149 index148 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">size_policy()-&gt;concurrent_precleaning_end();</code></div><div class="line number150 index149 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number151 index150 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp functions bold">assert</code><code class="cpp plain">(_collectorState == FinalMarking, </code><code class="cpp string">"Collector state should "</code></div><div class="line number152 index151 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp string">"have changed"</code><code class="cpp plain">);</code></div><div class="line number153 index152 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">break</code><code class="cpp plain">;</code></div><div class="line number154 index153 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">case</code> <code class="cpp plain">FinalMarking:</code></div><div class="line number155 index154 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">{</code></div><div class="line number156 index155 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">ReleaseForegroundGC x(</code><code class="cpp keyword bold">this</code><code class="cpp plain">);</code></div><div class="line number157 index156 alt2">&nbsp;</div><div class="line number158 index157 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">VM_CMS_Final_Remark final_remark_op(</code><code class="cpp keyword bold">this</code><code class="cpp plain">);</code></div><div class="line number159 index158 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">VMThread::execute(&amp;final_remark_op);</code></div><div class="line number160 index159 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number161 index160 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp functions bold">assert</code><code class="cpp plain">(_foregroundGCShouldWait, </code><code class="cpp string">"block post-condition"</code><code class="cpp plain">);</code></div><div class="line number162 index161 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">break</code><code class="cpp plain">;</code></div><div class="line number163 index162 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">case</code> <code class="cpp plain">Sweeping:</code></div><div class="line number164 index163 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(UseAdaptiveSizePolicy) {</code></div><div class="line number165 index164 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">size_policy()-&gt;concurrent_sweeping_begin();</code></div><div class="line number166 index165 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number167 index166 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">// final marking in checkpointRootsFinal has been completed</code></div><div class="line number168 index167 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">sweep(</code><code class="cpp keyword bold">true</code><code class="cpp plain">);</code></div><div class="line number169 index168 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp functions bold">assert</code><code class="cpp plain">(_collectorState == Resizing, </code><code class="cpp string">"Collector state change "</code></div><div class="line number170 index169 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp string">"to Resizing must be done under the free_list_lock"</code><code class="cpp plain">);</code></div><div class="line number171 index170 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">_full_gcs_since_conc_gc = 0;</code></div><div class="line number172 index171 alt1">&nbsp;</div><div class="line number173 index172 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">// Stop the timers for adaptive size policy for the concurrent phases</code></div><div class="line number174 index173 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(UseAdaptiveSizePolicy) {</code></div><div class="line number175 index174 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">size_policy()-&gt;concurrent_sweeping_end();</code></div><div class="line number176 index175 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">size_policy()-&gt;concurrent_phases_end(gch-&gt;gc_cause(),</code></div><div class="line number177 index176 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">gch-&gt;prev_gen(_cmsGen)-&gt;capacity(),</code></div><div class="line number178 index177 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">_cmsGen-&gt;</code><code class="cpp functions bold">free</code><code class="cpp plain">());</code></div><div class="line number179 index178 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number180 index179 alt1">&nbsp;</div><div class="line number181 index180 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">case</code> <code class="cpp plain">Resizing: {</code></div><div class="line number182 index181 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">// Sweeping has been completed...</code></div><div class="line number183 index182 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">// At this point the background collection has completed.</code></div><div class="line number184 index183 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">// Don't move the call to compute_new_size() down</code></div><div class="line number185 index184 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">// into code that might be executed if the background</code></div><div class="line number186 index185 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">// collection was preempted.</code></div><div class="line number187 index186 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">{</code></div><div class="line number188 index187 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">ReleaseForegroundGC x(</code><code class="cpp keyword bold">this</code><code class="cpp plain">);&nbsp;&nbsp; </code><code class="cpp comments">// unblock FG collection</code></div><div class="line number189 index188 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">MutexLockerEx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; y(Heap_lock, Mutex::_no_safepoint_check_flag);</code></div><div class="line number190 index189 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">CMSTokenSync&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; z(</code><code class="cpp keyword bold">true</code><code class="cpp plain">);&nbsp;&nbsp; </code><code class="cpp comments">// not strictly needed.</code></div><div class="line number191 index190 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(_collectorState == Resizing) {</code></div><div class="line number192 index191 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">compute_new_size();</code></div><div class="line number193 index192 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">_collectorState = Resetting;</code></div><div class="line number194 index193 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">} </code><code class="cpp keyword bold">else</code> <code class="cpp plain">{</code></div><div class="line number195 index194 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp functions bold">assert</code><code class="cpp plain">(_collectorState == Idling, </code><code class="cpp string">"The state should only change"</code></div><div class="line number196 index195 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp string">" because the foreground collector has finished the collection"</code><code class="cpp plain">);</code></div><div class="line number197 index196 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number198 index197 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number199 index198 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">break</code><code class="cpp plain">;</code></div><div class="line number200 index199 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number201 index200 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">case</code> <code class="cpp plain">Resetting:</code></div><div class="line number202 index201 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">// CMS heap resizing has been completed</code></div><div class="line number203 index202 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">reset(</code><code class="cpp keyword bold">true</code><code class="cpp plain">);</code></div><div class="line number204 index203 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp functions bold">assert</code><code class="cpp plain">(_collectorState == Idling, </code><code class="cpp string">"Collector state should "</code></div><div class="line number205 index204 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp string">"have changed"</code><code class="cpp plain">);</code></div><div class="line number206 index205 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">stats().record_cms_end();</code></div><div class="line number207 index206 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">// Don't move the concurrent_phases_end() and compute_new_size()</code></div><div class="line number208 index207 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">// calls to here because a preempted background collection</code></div><div class="line number209 index208 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">// has it's state set to "Resetting".</code></div><div class="line number210 index209 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">break</code><code class="cpp plain">;</code></div><div class="line number211 index210 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">case</code> <code class="cpp plain">Idling:</code></div><div class="line number212 index211 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">default</code><code class="cpp plain">:</code></div><div class="line number213 index212 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">ShouldNotReachHere();</code></div><div class="line number214 index213 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">break</code><code class="cpp plain">;</code></div><div class="line number215 index214 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number216 index215 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(TraceCMSState) {</code></div><div class="line number217 index216 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">gclog_or_tty-&gt;print_cr(</code><code class="cpp string">"&nbsp; Thread "</code> <code class="cpp plain">INTPTR_FORMAT </code><code class="cpp string">" done - next CMS state %d"</code><code class="cpp plain">,</code></div><div class="line number218 index217 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">Thread::current(), _collectorState);</code></div><div class="line number219 index218 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number220 index219 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp functions bold">assert</code><code class="cpp plain">(_foregroundGCShouldWait, </code><code class="cpp string">"block post-condition"</code><code class="cpp plain">);</code></div><div class="line number221 index220 alt2"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number222 index221 alt1">&nbsp;</div><div class="line number223 index222 alt2"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp comments">// Should this be in gc_epilogue?</code></div><div class="line number224 index223 alt1"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp plain">collector_policy()-&gt;counters()-&gt;update_counters();</code></div><div class="line number225 index224 alt2">&nbsp;</div><div class="line number226 index225 alt1"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp plain">{</code></div><div class="line number227 index226 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">// Clear _foregroundGCShouldWait and, in the event that the</code></div><div class="line number228 index227 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">// foreground collector is waiting, notify it, before</code></div><div class="line number229 index228 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp comments">// returning.</code></div><div class="line number230 index229 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">MutexLockerEx x(CGC_lock, Mutex::_no_safepoint_check_flag);</code></div><div class="line number231 index230 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">_foregroundGCShouldWait = </code><code class="cpp keyword bold">false</code><code class="cpp plain">;</code></div><div class="line number232 index231 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(_foregroundGCIsActive) {</code></div><div class="line number233 index232 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">CGC_lock-&gt;notify();</code></div><div class="line number234 index233 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number235 index234 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp functions bold">assert</code><code class="cpp plain">(!ConcurrentMarkSweepThread::cms_thread_has_cms_token(),</code></div><div class="line number236 index235 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp string">"Possible deadlock"</code><code class="cpp plain">);</code></div><div class="line number237 index236 alt2"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number238 index237 alt1"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(TraceCMSState) {</code></div><div class="line number239 index238 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">gclog_or_tty-&gt;print_cr(</code><code class="cpp string">"CMS Thread "</code> <code class="cpp plain">INTPTR_FORMAT</code></div><div class="line number240 index239 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp string">" exiting collection CMS state %d"</code><code class="cpp plain">,</code></div><div class="line number241 index240 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">Thread::current(), _collectorState);</code></div><div class="line number242 index241 alt1"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number243 index242 alt2"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp keyword bold">if</code> <code class="cpp plain">(PrintGC &amp;&amp; Verbose) {</code></div><div class="line number244 index243 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">_cmsGen-&gt;print_heap_change(prev_used);</code></div><div class="line number245 index244 alt2"><code class="cpp spaces">&nbsp;&nbsp;</code><code class="cpp plain">}</code></div><div class="line number246 index245 alt1"><code class="cpp plain">}</code></div></div></td></tr></tbody></table></div></div>
                        </div>
                    </div><h2 id="CMSGC问题探究-2.CMSFullGC源码">2.CMS Full GC源码</h2><div class="code panel pdl conf-macro output-block" style="border-width: 1px;" data-hasbody="true" data-macro-name="code">
                        <div class="codeHeader panelHeader pdl hide-border-bottom">
                            <b class="code-title"> </b>
                            <span class="collapse-source expand-control" style=""><span class="expand-control-icon icon expanded">&nbsp;</span><span class="expand-control-text">折叠原码</span></span>

                        </div>
                        <div class="codeContent panelContent pdl hide-toolbar show-border-top">
                            <div><div id="highlighter_759603" class="syntaxhighlighter sh-rdark  java expanded"><div class="toolbar"><span><a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" class="toolbar_item command_expandSource expandSource">expand source</a></span><span><a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div><div class="line number29 index28 alt2">29</div><div class="line number30 index29 alt1">30</div><div class="line number31 index30 alt2">31</div><div class="line number32 index31 alt1">32</div><div class="line number33 index32 alt2">33</div><div class="line number34 index33 alt1">34</div><div class="line number35 index34 alt2">35</div><div class="line number36 index35 alt1">36</div><div class="line number37 index36 alt2">37</div><div class="line number38 index37 alt1">38</div><div class="line number39 index38 alt2">39</div><div class="line number40 index39 alt1">40</div><div class="line number41 index40 alt2">41</div><div class="line number42 index41 alt1">42</div><div class="line number43 index42 alt2">43</div><div class="line number44 index43 alt1">44</div><div class="line number45 index44 alt2">45</div><div class="line number46 index45 alt1">46</div><div class="line number47 index46 alt2">47</div><div class="line number48 index47 alt1">48</div><div class="line number49 index48 alt2">49</div><div class="line number50 index49 alt1">50</div><div class="line number51 index50 alt2">51</div><div class="line number52 index51 alt1">52</div><div class="line number53 index52 alt2">53</div><div class="line number54 index53 alt1">54</div><div class="line number55 index54 alt2">55</div><div class="line number56 index55 alt1">56</div><div class="line number57 index56 alt2">57</div><div class="line number58 index57 alt1">58</div><div class="line number59 index58 alt2">59</div><div class="line number60 index59 alt1">60</div><div class="line number61 index60 alt2">61</div><div class="line number62 index61 alt1">62</div><div class="line number63 index62 alt2">63</div><div class="line number64 index63 alt1">64</div><div class="line number65 index64 alt2">65</div><div class="line number66 index65 alt1">66</div><div class="line number67 index66 alt2">67</div><div class="line number68 index67 alt1">68</div><div class="line number69 index68 alt2">69</div><div class="line number70 index69 alt1">70</div><div class="line number71 index70 alt2">71</div><div class="line number72 index71 alt1">72</div><div class="line number73 index72 alt2">73</div><div class="line number74 index73 alt1">74</div><div class="line number75 index74 alt2">75</div><div class="line number76 index75 alt1">76</div><div class="line number77 index76 alt2">77</div><div class="line number78 index77 alt1">78</div><div class="line number79 index78 alt2">79</div><div class="line number80 index79 alt1">80</div><div class="line number81 index80 alt2">81</div><div class="line number82 index81 alt1">82</div><div class="line number83 index82 alt2">83</div><div class="line number84 index83 alt1">84</div><div class="line number85 index84 alt2">85</div><div class="line number86 index85 alt1">86</div><div class="line number87 index86 alt2">87</div><div class="line number88 index87 alt1">88</div><div class="line number89 index88 alt2">89</div><div class="line number90 index89 alt1">90</div><div class="line number91 index90 alt2">91</div><div class="line number92 index91 alt1">92</div><div class="line number93 index92 alt2">93</div><div class="line number94 index93 alt1">94</div><div class="line number95 index94 alt2">95</div><div class="line number96 index95 alt1">96</div><div class="line number97 index96 alt2">97</div><div class="line number98 index97 alt1">98</div><div class="line number99 index98 alt2">99</div><div class="line number100 index99 alt1">100</div><div class="line number101 index100 alt2">101</div><div class="line number102 index101 alt1">102</div><div class="line number103 index102 alt2">103</div><div class="line number104 index103 alt1">104</div><div class="line number105 index104 alt2">105</div><div class="line number106 index105 alt1">106</div><div class="line number107 index106 alt2">107</div><div class="line number108 index107 alt1">108</div><div class="line number109 index108 alt2">109</div><div class="line number110 index109 alt1">110</div><div class="line number111 index110 alt2">111</div><div class="line number112 index111 alt1">112</div><div class="line number113 index112 alt2">113</div><div class="line number114 index113 alt1">114</div><div class="line number115 index114 alt2">115</div><div class="line number116 index115 alt1">116</div><div class="line number117 index116 alt2">117</div><div class="line number118 index117 alt1">118</div></td><td class="code"><div class="container" title="Hint: double-click to select code"><div class="line number1 index0 alt2"><code class="java keyword">void</code> <code class="java plain">CMSCollector::collect_in_foreground(bool clear_all_soft_refs) {</code></div><div class="line number2 index1 alt1"><code class="java spaces">&nbsp;&nbsp;</code><code class="java keyword">assert</code><code class="java plain">(_foregroundGCIsActive &amp;&amp; !_foregroundGCShouldWait,</code></div><div class="line number3 index2 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java string">"Foreground collector should be waiting, not executing"</code><code class="java plain">);</code></div><div class="line number4 index3 alt1"><code class="java spaces">&nbsp;&nbsp;</code><code class="java keyword">assert</code><code class="java plain">(Thread::current()-&gt;is_VM_thread(), </code><code class="java string">"A foreground collection"</code></div><div class="line number5 index4 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java string">"may only be done by the VM Thread with the world stopped"</code><code class="java plain">);</code></div><div class="line number6 index5 alt1"><code class="java spaces">&nbsp;&nbsp;</code><code class="java keyword">assert</code><code class="java plain">(ConcurrentMarkSweepThread::vm_thread_has_cms_token(),</code></div><div class="line number7 index6 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java string">"VM thread should have CMS token"</code><code class="java plain">);</code></div><div class="line number8 index7 alt1">&nbsp;</div><div class="line number9 index8 alt2"><code class="java spaces">&nbsp;&nbsp;</code><code class="java plain">NOT_PRODUCT(TraceTime t(</code><code class="java string">"CMS:MS (foreground) "</code><code class="java plain">, PrintGCDetails &amp;&amp; Verbose,</code></div><div class="line number10 index9 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">true</code><code class="java plain">, gclog_or_tty);)</code></div><div class="line number11 index10 alt2"><code class="java spaces">&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(UseAdaptiveSizePolicy) {</code></div><div class="line number12 index11 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">size_policy()-&gt;ms_collection_begin();</code></div><div class="line number13 index12 alt2"><code class="java spaces">&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number14 index13 alt1"><code class="java spaces">&nbsp;&nbsp;</code><code class="java plain">COMPILER2_PRESENT(DerivedPointerTableDeactivate dpt_deact);</code></div><div class="line number15 index14 alt2">&nbsp;</div><div class="line number16 index15 alt1"><code class="java spaces">&nbsp;&nbsp;</code><code class="java plain">HandleMark hm;&nbsp; </code><code class="java comments">// Discard invalid handles created during verification</code></div><div class="line number17 index16 alt2">&nbsp;</div><div class="line number18 index17 alt1"><code class="java spaces">&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(VerifyBeforeGC &amp;&amp;</code></div><div class="line number19 index18 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">GenCollectedHeap::heap()-&gt;total_collections() &gt;= VerifyGCStartAt) {</code></div><div class="line number20 index19 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Universe::verify(</code><code class="java keyword">true</code><code class="java plain">);</code></div><div class="line number21 index20 alt2"><code class="java spaces">&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number22 index21 alt1">&nbsp;</div><div class="line number23 index22 alt2"><code class="java spaces">&nbsp;&nbsp;</code><code class="java comments">// Snapshot the soft reference policy to be used in this collection cycle.</code></div><div class="line number24 index23 alt1"><code class="java spaces">&nbsp;&nbsp;</code><code class="java plain">ref_processor()-&gt;setup_policy(clear_all_soft_refs);</code></div><div class="line number25 index24 alt2">&nbsp;</div><div class="line number26 index25 alt1"><code class="java spaces">&nbsp;&nbsp;</code><code class="java plain">bool init_mark_was_synchronous = </code><code class="java keyword">false</code><code class="java plain">; </code><code class="java comments">// until proven otherwise</code></div><div class="line number27 index26 alt2"><code class="java spaces">&nbsp;&nbsp;</code><code class="java keyword">while</code> <code class="java plain">(_collectorState != Idling) {</code></div><div class="line number28 index27 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(TraceCMSState) {</code></div><div class="line number29 index28 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">gclog_or_tty-&gt;print_cr(</code><code class="java string">"Thread "</code> <code class="java plain">INTPTR_FORMAT </code><code class="java string">" in CMS state %d"</code><code class="java plain">,</code></div><div class="line number30 index29 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Thread::current(), _collectorState);</code></div><div class="line number31 index30 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number32 index31 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">switch</code> <code class="java plain">(_collectorState) {</code></div><div class="line number33 index32 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">case</code> <code class="java plain">InitialMarking:</code></div><div class="line number34 index33 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">init_mark_was_synchronous = </code><code class="java keyword">true</code><code class="java plain">;&nbsp; </code><code class="java comments">// fact to be exploited in re-mark</code></div><div class="line number35 index34 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">checkpointRootsInitial(</code><code class="java keyword">false</code><code class="java plain">);</code></div><div class="line number36 index35 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">assert</code><code class="java plain">(_collectorState == Marking, </code><code class="java string">"Collector state should have changed"</code></div><div class="line number37 index36 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java string">" within checkpointRootsInitial()"</code><code class="java plain">);</code></div><div class="line number38 index37 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">break</code><code class="java plain">;</code></div><div class="line number39 index38 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">case</code> <code class="java plain">Marking:</code></div><div class="line number40 index39 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">// initial marking in checkpointRootsInitialWork has been completed</code></div><div class="line number41 index40 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(VerifyDuringGC &amp;&amp;</code></div><div class="line number42 index41 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">GenCollectedHeap::heap()-&gt;total_collections() &gt;= VerifyGCStartAt) {</code></div><div class="line number43 index42 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">gclog_or_tty-&gt;print(</code><code class="java string">"Verify before initial mark: "</code><code class="java plain">);</code></div><div class="line number44 index43 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Universe::verify(</code><code class="java keyword">true</code><code class="java plain">);</code></div><div class="line number45 index44 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number46 index45 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">{</code></div><div class="line number47 index46 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">bool res = markFromRoots(</code><code class="java keyword">false</code><code class="java plain">);</code></div><div class="line number48 index47 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">assert</code><code class="java plain">(res &amp;&amp; _collectorState == FinalMarking, </code><code class="java string">"Collector state should "</code></div><div class="line number49 index48 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java string">"have changed"</code><code class="java plain">);</code></div><div class="line number50 index49 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">break</code><code class="java plain">;</code></div><div class="line number51 index50 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number52 index51 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">case</code> <code class="java plain">FinalMarking:</code></div><div class="line number53 index52 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(VerifyDuringGC &amp;&amp;</code></div><div class="line number54 index53 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">GenCollectedHeap::heap()-&gt;total_collections() &gt;= VerifyGCStartAt) {</code></div><div class="line number55 index54 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">gclog_or_tty-&gt;print(</code><code class="java string">"Verify before re-mark: "</code><code class="java plain">);</code></div><div class="line number56 index55 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Universe::verify(</code><code class="java keyword">true</code><code class="java plain">);</code></div><div class="line number57 index56 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number58 index57 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">checkpointRootsFinal(</code><code class="java keyword">false</code><code class="java plain">, clear_all_soft_refs,</code></div><div class="line number59 index58 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">init_mark_was_synchronous);</code></div><div class="line number60 index59 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">assert</code><code class="java plain">(_collectorState == Sweeping, </code><code class="java string">"Collector state should not "</code></div><div class="line number61 index60 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java string">"have changed within checkpointRootsFinal()"</code><code class="java plain">);</code></div><div class="line number62 index61 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">break</code><code class="java plain">;</code></div><div class="line number63 index62 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">case</code> <code class="java plain">Sweeping:</code></div><div class="line number64 index63 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">// final marking in checkpointRootsFinal has been completed</code></div><div class="line number65 index64 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(VerifyDuringGC &amp;&amp;</code></div><div class="line number66 index65 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">GenCollectedHeap::heap()-&gt;total_collections() &gt;= VerifyGCStartAt) {</code></div><div class="line number67 index66 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">gclog_or_tty-&gt;print(</code><code class="java string">"Verify before sweep: "</code><code class="java plain">);</code></div><div class="line number68 index67 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Universe::verify(</code><code class="java keyword">true</code><code class="java plain">);</code></div><div class="line number69 index68 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number70 index69 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">sweep(</code><code class="java keyword">false</code><code class="java plain">);</code></div><div class="line number71 index70 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">assert</code><code class="java plain">(_collectorState == Resizing, </code><code class="java string">"Incorrect state"</code><code class="java plain">);</code></div><div class="line number72 index71 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">break</code><code class="java plain">;</code></div><div class="line number73 index72 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">case</code> <code class="java plain">Resizing: {</code></div><div class="line number74 index73 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">// Sweeping has been completed; the actual resize in this case</code></div><div class="line number75 index74 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">// is done separately; nothing to be done in this state.</code></div><div class="line number76 index75 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">_collectorState = Resetting;</code></div><div class="line number77 index76 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">break</code><code class="java plain">;</code></div><div class="line number78 index77 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number79 index78 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">case</code> <code class="java plain">Resetting:</code></div><div class="line number80 index79 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">// The heap has been resized.</code></div><div class="line number81 index80 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(VerifyDuringGC &amp;&amp;</code></div><div class="line number82 index81 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">GenCollectedHeap::heap()-&gt;total_collections() &gt;= VerifyGCStartAt) {</code></div><div class="line number83 index82 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">gclog_or_tty-&gt;print(</code><code class="java string">"Verify before reset: "</code><code class="java plain">);</code></div><div class="line number84 index83 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Universe::verify(</code><code class="java keyword">true</code><code class="java plain">);</code></div><div class="line number85 index84 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number86 index85 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">reset(</code><code class="java keyword">false</code><code class="java plain">);</code></div><div class="line number87 index86 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">assert</code><code class="java plain">(_collectorState == Idling, </code><code class="java string">"Collector state should "</code></div><div class="line number88 index87 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java string">"have changed"</code><code class="java plain">);</code></div><div class="line number89 index88 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">break</code><code class="java plain">;</code></div><div class="line number90 index89 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">case</code> <code class="java plain">Precleaning:</code></div><div class="line number91 index90 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">case</code> <code class="java plain">AbortablePreclean:</code></div><div class="line number92 index91 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">// Elide the preclean phase</code></div><div class="line number93 index92 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">_collectorState = FinalMarking;</code></div><div class="line number94 index93 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">break</code><code class="java plain">;</code></div><div class="line number95 index94 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">default</code><code class="java plain">:</code></div><div class="line number96 index95 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">ShouldNotReachHere();</code></div><div class="line number97 index96 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number98 index97 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(TraceCMSState) {</code></div><div class="line number99 index98 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">gclog_or_tty-&gt;print_cr(</code><code class="java string">"&nbsp; Thread "</code> <code class="java plain">INTPTR_FORMAT </code><code class="java string">" done - next CMS state %d"</code><code class="java plain">,</code></div><div class="line number100 index99 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Thread::current(), _collectorState);</code></div><div class="line number101 index100 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number102 index101 alt1"><code class="java spaces">&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number103 index102 alt2">&nbsp;</div><div class="line number104 index103 alt1"><code class="java spaces">&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(UseAdaptiveSizePolicy) {</code></div><div class="line number105 index104 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">GenCollectedHeap* gch = GenCollectedHeap::heap();</code></div><div class="line number106 index105 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">size_policy()-&gt;ms_collection_end(gch-&gt;gc_cause());</code></div><div class="line number107 index106 alt2"><code class="java spaces">&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number108 index107 alt1">&nbsp;</div><div class="line number109 index108 alt2"><code class="java spaces">&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(VerifyAfterGC &amp;&amp;</code></div><div class="line number110 index109 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">GenCollectedHeap::heap()-&gt;total_collections() &gt;= VerifyGCStartAt) {</code></div><div class="line number111 index110 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Universe::verify(</code><code class="java keyword">true</code><code class="java plain">);</code></div><div class="line number112 index111 alt1"><code class="java spaces">&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number113 index112 alt2"><code class="java spaces">&nbsp;&nbsp;</code><code class="java keyword">if</code> <code class="java plain">(TraceCMSState) {</code></div><div class="line number114 index113 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">gclog_or_tty-&gt;print_cr(</code><code class="java string">"CMS Thread "</code> <code class="java plain">INTPTR_FORMAT</code></div><div class="line number115 index114 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java string">" exiting collection CMS state %d"</code><code class="java plain">,</code></div><div class="line number116 index115 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Thread::current(), _collectorState);</code></div><div class="line number117 index116 alt2"><code class="java spaces">&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number118 index117 alt1"><code class="java plain">}</code></div></div></td></tr></tbody></table></div></div>
                        </div>
                    </div><p>&nbsp;</p><pre>&nbsp;</pre><p>&nbsp;</p><pre>&nbsp;</pre><pre>&nbsp;</pre>




                    </div>

                    <!--
            <rdf:RDF xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
                     xmlns:dc="http://purl.org/dc/elements/1.1/"
                     xmlns:trackback="http://madskills.com/public/xml/rss/module/trackback/">
                     <rdf:Description
                rdf:about="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662"
                dc:identifier="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662"
                dc:title="CMS GC问题探究"
                trackback:ping="https://wiki.sankuai.com/rpc/trackback/1079095662"/>
            </rdf:RDF>
            -->


























                    <div id="comments-section" class="pageSection group">




                        <div class="bottom-comment-panels comment-panels">








                            <div class="quick-comment-container comment add"><p class="comment-user-logo"><a class="userLogoLink userlink-1" data-username="jun.xu" href="https://wiki.sankuai.com/display/~jun.xu" title="" data-user-hover-bound="true"></a></p><div class="quick-comment-body"><div class="quick-comment-loading-container" style="display:none;"></div><div id="editor-messages"></div><div id="all-messages"></div><form style="display:block;" class="quick-comment-form aui" method="post" name="inlinecommentform" action="https://wiki.sankuai.com/pages/doaddcomment.action?pageId=1079095662"></form></div></div>

                        </div>

                        <div id="comments-actions" class="aui-toolbar noprint" style="display: none;">
                            <p class="toolbar-group">
                                <span class="toolbar-item"><a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662&amp;showComments=true&amp;showCommentArea=true#addcomment" id="add-comment-rte" accesskey="m" class="toolbar-trigger">添加评论</a></span>
                            </p>
                        </div>
                    </div>






                </div>

















                <div id="space-tools-web-items" class="hidden">
                    <div data-label="概览" data-href="/spaces/viewspacesummary.action?key=YHYX">概览</div>
                    <div data-label="权限" data-href="/spaces/spacepermissions.action?key=YHYX">权限</div>
                    <div data-label="内容工具" data-href="/pages/templates2/listpagetemplates.action?key=YHYX">内容工具</div>
                    <div data-label="外观" data-href="/spaces/choosetheme.action?key=YHYX">外观</div>
                    <div data-label="集成" data-href="/spaces/hipchat2.action?key=YHYX">集成</div>
                </div>




            </div><!-- \#main -->







            <div id="footer" role="contentinfo" style="margin-left: 55px;">

            </div>


        </div>

    </div><!-- \#full-height-container -->
</div><!-- \#page -->

<span style="display:none;" id="confluence-server-performance">{"serverDuration": 218, "requestCorrelationId": "59d7056c6b487948"}</span>


<script type="text/javascript">
    AJS.BigPipe = AJS.BigPipe || {};
    AJS.BigPipe.metrics = AJS.BigPipe.metrics || {};
    AJS.BigPipe.metrics.pageEnd = typeof window.performance !== "undefined" && typeof window.performance.now === "function"
        ? Math.ceil(window.performance.now()) : 0;
    AJS.BigPipe.metrics.isBigPipeEnabled = 'false' === 'true';
</script>



<div id="editor-preload-container" style="display: none;">


    <div class="hidden">



        <content tag="breadcrumbs">


            <ol id="quickedit-breadcrumbs">


                <li class="first">

                    <span class=""><a href="https://wiki.sankuai.com/display/YHYX" target="_blank">用户与营销技术部</a></span>


                </li><li>

                <span class=""><a href="https://wiki.sankuai.com/collector/pages.action?key=YHYX" target="_blank">页面</a></span>
            </li><li id="ellipsis" title="显示全部导航项"><span><strong>…</strong></span></li>


                <li class="hidden-crumb">

                    <span class=""><a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=452302306" target="_blank">新垂直业务研发组</a></span>


                </li><li class="hidden-crumb">

                <span class=""><a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1052761851" target="_blank">08.新垂直分享</a></span>


            </li><li>

                <span class=""><a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=493027971" target="_blank">技术原创</a></span>


            </li><li>

                <span class="edited-page-title"><a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662" target="_blank">CMS GC问题探究</a></span>
            </li></ol>

        </content>
    </div>







    <script type="text/x-template" title="editor-css" id="editor-css-resources">
        <link type="text/css" rel="stylesheet" href="/s/d41d8cd98f00b204e9800998ecf8427e-CDN/zh_CN/6441/3dfb154e647c41466ff19113f0197feded41ba10/1.1.11/_/download/batch/com.atlassian.confluence.plugins.confluence-collaborative-editor-plugin:confluence-collaborative-editor-plugin-editor-content-resources/com.atlassian.confluence.plugins.confluence-collaborative-editor-plugin:confluence-collaborative-editor-plugin-editor-content-resources.css" data-wrm-key="com.atlassian.confluence.plugins.confluence-collaborative-editor-plugin:confluence-collaborative-editor-plugin-editor-content-resources" data-wrm-batch-type="resource" media="all">
        <link type="text/css" rel="stylesheet" href="/s/94a81e66fd81aec5ae5bfbc2c97ebbab-CDN/zh_CN/6441/3dfb154e647c41466ff19113f0197feded41ba10/5.9.22/_/download/batch/com.atlassian.auiplugin:aui-page-typography/com.atlassian.auiplugin:aui-page-typography.css" data-wrm-key="com.atlassian.auiplugin:aui-page-typography" data-wrm-batch-type="resource" media="all">
        <link type="text/css" rel="stylesheet" href="/s/94a81e66fd81aec5ae5bfbc2c97ebbab-CDN/zh_CN/6441/3dfb154e647c41466ff19113f0197feded41ba10/5.9.22/_/download/batch/com.atlassian.auiplugin:aui-avatars/com.atlassian.auiplugin:aui-avatars.css" data-wrm-key="com.atlassian.auiplugin:aui-avatars" data-wrm-batch-type="resource" media="all">
        <link type="text/css" rel="stylesheet" href="/s/3c874ac88a1025fff1981484090cfc36-CDN/zh_CN/6441/3dfb154e647c41466ff19113f0197feded41ba10/5.9.22/_/download/batch/com.atlassian.auiplugin:aui-page-layout/com.atlassian.auiplugin:aui-page-layout.css" data-wrm-key="com.atlassian.auiplugin:aui-page-layout" data-wrm-batch-type="resource" media="all">
        <link type="text/css" rel="stylesheet" href="/s/79934aefd8f55263a09131dc831346e0-CDN/zh_CN/6441/3dfb154e647c41466ff19113f0197feded41ba10/5.10.2/_/download/batch/com.atlassian.confluence.editor:editor-content-styles/com.atlassian.confluence.editor:editor-content-styles.css" data-wrm-key="com.atlassian.confluence.editor:editor-content-styles" data-wrm-batch-type="resource" media="all">
        <link type="text/css" rel="stylesheet" href="/s/79934aefd8f55263a09131dc831346e0-CDN/zh_CN/6441/3dfb154e647c41466ff19113f0197feded41ba10/5.10.2/_/download/batch/com.atlassian.confluence.editor:table-resizable-editor-content-styles/com.atlassian.confluence.editor:table-resizable-editor-content-styles.css?confluence.table.resizable=true" data-wrm-key="com.atlassian.confluence.editor:table-resizable-editor-content-styles" data-wrm-batch-type="resource" media="all">
        <link type="text/css" rel="stylesheet" href="/s/79934aefd8f55263a09131dc831346e0-CDN/zh_CN/6441/3dfb154e647c41466ff19113f0197feded41ba10/5.10.2/_/download/batch/com.atlassian.confluence.editor:table-resizable-styles/com.atlassian.confluence.editor:table-resizable-styles.css?confluence.table.resizable=true" data-wrm-key="com.atlassian.confluence.editor:table-resizable-styles" data-wrm-batch-type="resource" media="all">
        <link type="text/css" rel="stylesheet" href="/s/d41d8cd98f00b204e9800998ecf8427e-CDN/zh_CN/6441/3dfb154e647c41466ff19113f0197feded41ba10/5.10.2/_/download/batch/com.atlassian.confluence.plugins.confluence-templates:variable-editor-content-styles/com.atlassian.confluence.plugins.confluence-templates:variable-editor-content-styles.css" data-wrm-key="com.atlassian.confluence.plugins.confluence-templates:variable-editor-content-styles" data-wrm-batch-type="resource" media="all">
        <link type="text/css" rel="stylesheet" href="/s/94a81e66fd81aec5ae5bfbc2c97ebbab-CDN/zh_CN/6441/3dfb154e647c41466ff19113f0197feded41ba10/5.9.22/_/download/batch/com.atlassian.auiplugin:aui-lozenge/com.atlassian.auiplugin:aui-lozenge.css" data-wrm-key="com.atlassian.auiplugin:aui-lozenge" data-wrm-batch-type="resource" media="all">
        <link type="text/css" rel="stylesheet" href="/s/d41d8cd98f00b204e9800998ecf8427e-CDN/zh_CN/6441/3dfb154e647c41466ff19113f0197feded41ba10/2.17/_/download/batch/com.atlassian.confluence.plugins.status-macro:view_content_status/com.atlassian.confluence.plugins.status-macro:view_content_status.css" data-wrm-key="com.atlassian.confluence.plugins.status-macro:view_content_status" data-wrm-batch-type="resource" media="all">
        <link type="text/css" rel="stylesheet" href="/s/489901e715cade6fe0efc7e21e194576-CDN/zh_CN/6441/3dfb154e647c41466ff19113f0197feded41ba10/2.17/_/download/batch/com.atlassian.confluence.plugins.status-macro:editor_content_status/com.atlassian.confluence.plugins.status-macro:editor_content_status.css" data-wrm-key="com.atlassian.confluence.plugins.status-macro:editor_content_status" data-wrm-batch-type="resource" media="all">
        <link type="text/css" rel="stylesheet" href="/s/d0638b94054c44b2ca8199723136b528-CDN/zh_CN/6441/3dfb154e647c41466ff19113f0197feded41ba10/1.2.8/_/download/batch/com.atlassian.confluence.plugins.confluence-fixed-headers:confluence-fixed-headers-editor-content-resources/com.atlassian.confluence.plugins.confluence-fixed-headers:confluence-fixed-headers-editor-content-resources.css?confluence.view.edit.transition=true" data-wrm-key="com.atlassian.confluence.plugins.confluence-fixed-headers:confluence-fixed-headers-editor-content-resources" data-wrm-batch-type="resource" media="all">
        <link type="text/css" rel="stylesheet" href="/s/5baeb58a5608e28c5f241eee74f064b2-CDN/zh_CN/6441/3dfb154e647c41466ff19113f0197feded41ba10/4.0.2/_/download/batch/confluence.extra.attachments:attachments-css/confluence.extra.attachments:attachments-css.css" data-wrm-key="confluence.extra.attachments:attachments-css" data-wrm-batch-type="resource" media="all">
        <link type="text/css" rel="stylesheet" href="/s/d41d8cd98f00b204e9800998ecf8427e-CDN/zh_CN/6441/3dfb154e647c41466ff19113f0197feded41ba10/2.6.1/_/download/batch/nl.avisi.confluence.plugins.numberedheadings:nh-tinymce-css-resources/nl.avisi.confluence.plugins.numberedheadings:nh-tinymce-css-resources.css" data-wrm-key="nl.avisi.confluence.plugins.numberedheadings:nh-tinymce-css-resources" data-wrm-batch-type="resource" media="all">
        <link type="text/css" rel="stylesheet" href="/s/d41d8cd98f00b204e9800998ecf8427e-CDN/zh_CN/6441/3dfb154e647c41466ff19113f0197feded41ba10/13.0.0/_/download/batch/com.atlassian.confluence.plugins.confluence-roadmap-plugin:roadmap-placeholder-css/com.atlassian.confluence.plugins.confluence-roadmap-plugin:roadmap-placeholder-css.css" data-wrm-key="com.atlassian.confluence.plugins.confluence-roadmap-plugin:roadmap-placeholder-css" data-wrm-batch-type="resource" media="all">
        <link type="text/css" rel="stylesheet" href="/s/d41d8cd98f00b204e9800998ecf8427e-CDN/zh_CN/6441/3dfb154e647c41466ff19113f0197feded41ba10/1.0/_/download/batch/confluence.web.resources:panel-styles/confluence.web.resources:panel-styles.css" data-wrm-key="confluence.web.resources:panel-styles" data-wrm-batch-type="resource" media="all">
        <link type="text/css" rel="stylesheet" href="/s/20290649bd1f3077e1eb286014d15d1f-CDN/zh_CN/6441/3dfb154e647c41466ff19113f0197feded41ba10/1.0/_/download/batch/confluence.web.resources:content-styles/confluence.web.resources:content-styles.css" data-wrm-key="confluence.web.resources:content-styles" data-wrm-batch-type="resource" media="all">
        <link type="text/css" rel="stylesheet" href="/s/d41d8cd98f00b204e9800998ecf8427e-CDN/zh_CN/6441/3dfb154e647c41466ff19113f0197feded41ba10/5.10.2/_/download/batch/com.atlassian.confluence.plugins.confluence-page-layout:editor-pagelayout-content-styles/com.atlassian.confluence.plugins.confluence-page-layout:editor-pagelayout-content-styles.css" data-wrm-key="com.atlassian.confluence.plugins.confluence-page-layout:editor-pagelayout-content-styles" data-wrm-batch-type="resource" media="all">
        <link type="text/css" rel="stylesheet" href="/s/d41d8cd98f00b204e9800998ecf8427e-CDN/zh_CN/6441/3dfb154e647c41466ff19113f0197feded41ba10/4.1.4/_/download/batch/com.atlassian.confluence.plugins.confluence-business-blueprints:sharelinks-urlmacro-editor-resources/com.atlassian.confluence.plugins.confluence-business-blueprints:sharelinks-urlmacro-editor-resources.css" data-wrm-key="com.atlassian.confluence.plugins.confluence-business-blueprints:sharelinks-urlmacro-editor-resources" data-wrm-batch-type="resource" media="all">
        <link type="text/css" rel="stylesheet" href="/s/d41d8cd98f00b204e9800998ecf8427e-CDN/zh_CN/6441/3dfb154e647c41466ff19113f0197feded41ba10/7.0.2/_/download/batch/com.atlassian.confluence.plugins.confluence-inline-tasks:inline-tasks-styles/com.atlassian.confluence.plugins.confluence-inline-tasks:inline-tasks-styles.css" data-wrm-key="com.atlassian.confluence.plugins.confluence-inline-tasks:inline-tasks-styles" data-wrm-batch-type="resource" media="all">
        <link type="text/css" rel="stylesheet" href="/s/d41d8cd98f00b204e9800998ecf8427e-CDN/zh_CN/6441/3dfb154e647c41466ff19113f0197feded41ba10/7.0.2/_/download/batch/com.atlassian.confluence.plugins.confluence-inline-tasks:editor-autocomplete-date-css/com.atlassian.confluence.plugins.confluence-inline-tasks:editor-autocomplete-date-css.css" data-wrm-key="com.atlassian.confluence.plugins.confluence-inline-tasks:editor-autocomplete-date-css" data-wrm-batch-type="resource" media="all">
        <!--[if lte IE 9]>
        <link type="text/css" rel="stylesheet" href="/s/d41d8cd98f00b204e9800998ecf8427e-CDN/zh_CN/6441/3dfb154e647c41466ff19113f0197feded41ba10/7.0.2/_/download/batch/com.atlassian.confluence.plugins.confluence-inline-tasks:editor-autocomplete-date-css/com.atlassian.confluence.plugins.confluence-inline-tasks:editor-autocomplete-date-css.css?conditionalComment=lte+IE+9" data-wrm-key="com.atlassian.confluence.plugins.confluence-inline-tasks:editor-autocomplete-date-css" data-wrm-batch-type="resource" media="all">
        <![endif]-->
        <link type="text/css" rel="stylesheet" href="/s/3c1de4a43daa0fe17b5080559cff640e-CDN/zh_CN/6441/3dfb154e647c41466ff19113f0197feded41ba10/1.5.3/_/download/batch/com.atlassian.confluence.plugins.confluence-view-file-macro:view-file-macro-editor-content-resources/com.atlassian.confluence.plugins.confluence-view-file-macro:view-file-macro-editor-content-resources.css" data-wrm-key="com.atlassian.confluence.plugins.confluence-view-file-macro:view-file-macro-editor-content-resources" data-wrm-batch-type="resource" media="all">
        <link type="text/css" rel="stylesheet" href="/s/d41d8cd98f00b204e9800998ecf8427e-CDN/zh_CN/6441/3dfb154e647c41466ff19113f0197feded41ba10/3.1.4/_/download/batch/com.atlassian.confluence.plugins.confluence-software-blueprints:common-resources/com.atlassian.confluence.plugins.confluence-software-blueprints:common-resources.css" data-wrm-key="com.atlassian.confluence.plugins.confluence-software-blueprints:common-resources" data-wrm-batch-type="resource" media="all">

    </script>















    <div class="editor-container">




        <div id="link-browser-tab-items" class="hidden">
            <div title="搜索" data-weight="10">search</div>
            <div title="最近浏览过" data-weight="20">recentlyviewed</div>
            <div title="Files" data-weight="30">attachments</div>
            <div title="Web链接" data-weight="40">weblink</div>
            <div title="高级" data-weight="50">advanced</div>
        </div>
        <div id="image-properties-tab-items" class="hidden">
            <div title="效果" data-weight="10">image-effects</div>
            <div title="标题" data-weight="20">image-attributes</div>
        </div>












        <div id="toolbar">
            <div id="rte-toolbar" class="aui-toolbar aui-toolbar2">

                <div class="aui-toolbar2-primary toolbar-primary">
                    <ul class="aui-buttons rte-toolbar-group-formatting">
                        <li id="format-dropdown" class="toolbar-item toolbar-dropdown">
                            <div class="aui-dd-parent">
                                <a id="format-dropdown-display" href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" class="toolbar-trigger aui-dd-trigger aui-button" data-control-id="formatselect">
                                    <span class="dropdown-text">正文</span>


                                    <span class="icon aui-icon aui-icon-small aui-iconfont-dropdown "></span>
                                </a>
                                <ul id="format-dropdown-display-menu" class="aui-dropdown hidden">
                                    <li class="dropdown-item format-p" data-format="p" data-tooltip="正文 (Ctrl+0)">
                                        <a class="item-link" href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#">正文</a>
                                    </li>
                                    <li class="dropdown-item format-h1" data-format="h1" data-tooltip="标题 1 (Ctrl+1)">
                                        <a class="item-link" href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#">标题 1</a>
                                    </li>
                                    <li class="dropdown-item format-h2" data-format="h2" data-tooltip="标题 2 (Ctrl+2)">
                                        <a class="item-link" href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#">标题 2</a>
                                    </li>
                                    <li class="dropdown-item format-h3" data-format="h3" data-tooltip="标题 3 (Ctrl+3)">
                                        <a class="item-link" href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#">标题 3</a>
                                    </li>
                                    <li class="dropdown-item format-h4" data-format="h4" data-tooltip="标题 4 (Ctrl+4)">
                                        <a class="item-link" href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#">标题 4</a>
                                    </li>
                                    <li class="dropdown-item format-h5" data-format="h5" data-tooltip="标题 5 (Ctrl+5)">
                                        <a class="item-link" href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#">标题 5</a>
                                    </li>
                                    <li class="dropdown-item format-h6" data-format="h6" data-tooltip="标题 6 (Ctrl+6)">
                                        <a class="item-link" href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#">标题 6</a>
                                    </li>
                                    <li class="dropdown-item format-pre" data-format="pre" data-tooltip="预格式化 (Ctrl+7)">
                                        <a class="item-link" href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#">预格式化</a>
                                    </li>
                                    <li class="dropdown-item format-blockquote" data-format="blockquote" data-tooltip="引用 (Ctrl+8)">
                                        <a class="item-link" href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#">引用</a>
                                    </li>
                                </ul>
                            </div>
                        </li>
                    </ul>

                    <ul class="aui-buttons rte-toolbar-group-style">

                        <li class="toolbar-item aui-button" id="rte-button-bold" data-tooltip="粗体 (Ctrl+B)">
                            <a class="toolbar-trigger" href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" data-control-id="bold">


                                <span class="icon aui-icon aui-icon-small aui-iconfont-editor-bold ">粗体</span>
                            </a>
                        </li>

                        <li class="toolbar-item aui-button" id="rte-button-italic" data-tooltip="斜体 (Ctrl+I)">
                            <a class="toolbar-trigger" href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" data-control-id="italic">


                                <span class="icon aui-icon aui-icon-small aui-iconfont-editor-italic ">斜体</span>
                            </a>
                        </li>

                        <li class="toolbar-item aui-button" id="rte-button-underline" data-tooltip="下划线 (Ctrl+U)">
                            <a class="toolbar-trigger" href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" data-control-id="underline">


                                <span class="icon aui-icon aui-icon-small aui-iconfont-editor-underline ">下划线</span>
                            </a>
                        </li>
                        <li id="color-picker-control" class="toolbar-item toolbar-splitbutton">
                            <a class="toolbar-trigger aui-button" href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" id="rte-button-color" data-color="003366" data-tooltip="颜色"><span class="icon aui-icon aui-icon-small aui-iconfont-editor-color ">颜色选取器</span><span class="selected-color"></span></a><div class="aui-dd-parent"><a class="toolbar-trigger aui-dd-trigger aui-button" href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" id="rte-button-color-selector" data-control-id="colorSelector" data-tooltip="更多颜色"><span class="icon aui-icon aui-icon-small aui-iconfont-dropdown ">更多颜色</span></a><div class="color-picker-container"><div class="color-picker aui-dropdown hidden"><ul><li><a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" style="background-color: #000000" data-color="000000">&nbsp;</a></li><li><a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" style="background-color: #993300" data-color="993300">&nbsp;</a></li><li><a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" style="background-color: #333300" data-color="333300">&nbsp;</a></li><li><a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" style="background-color: #003300" data-color="003300">&nbsp;</a></li><li><a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" style="background-color: #003366" data-color="003366">&nbsp;</a></li><li><a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" style="background-color: #000080" data-color="000080">&nbsp;</a></li><li><a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" style="background-color: #333399" data-color="333399">&nbsp;</a></li><li><a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" style="background-color: #333333" data-color="333333">&nbsp;</a></li><li><a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" style="background-color: #800000" data-color="800000">&nbsp;</a></li><li><a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" style="background-color: #FF6600" data-color="FF6600">&nbsp;</a></li><li><a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" style="background-color: #808000" data-color="808000">&nbsp;</a></li><li><a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" style="background-color: #008000" data-color="008000">&nbsp;</a></li><li><a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" style="background-color: #008080" data-color="008080">&nbsp;</a></li><li><a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" style="background-color: #0000FF" data-color="0000FF">&nbsp;</a></li><li><a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" style="background-color: #666699" data-color="666699">&nbsp;</a></li><li><a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" style="background-color: #808080" data-color="808080">&nbsp;</a></li><li><a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" style="background-color: #FF0000" data-color="FF0000">&nbsp;</a></li><li><a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" style="background-color: #FF9900" data-color="FF9900">&nbsp;</a></li><li><a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" style="background-color: #99CC00" data-color="99CC00">&nbsp;</a></li><li><a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" style="background-color: #339966" data-color="339966">&nbsp;</a></li><li><a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" style="background-color: #33CCCC" data-color="33CCCC">&nbsp;</a></li><li><a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" style="background-color: #3366FF" data-color="3366FF">&nbsp;</a></li><li><a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" style="background-color: #800080" data-color="800080">&nbsp;</a></li><li><a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" style="background-color: #999999" data-color="999999">&nbsp;</a></li><li><a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" style="background-color: #FF00FF" data-color="FF00FF">&nbsp;</a></li><li><a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" style="background-color: #FFCC00" data-color="FFCC00">&nbsp;</a></li><li><a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" style="background-color: #FFFF00" data-color="FFFF00">&nbsp;</a></li><li><a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" style="background-color: #00FF00" data-color="00FF00">&nbsp;</a></li><li><a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" style="background-color: #00FFFF" data-color="00FFFF">&nbsp;</a></li><li><a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" style="background-color: #00CCFF" data-color="00CCFF">&nbsp;</a></li><li><a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" style="background-color: #993366" data-color="993366">&nbsp;</a></li><li><a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" style="background-color: #C0C0C0" data-color="C0C0C0">&nbsp;</a></li><li><a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" style="background-color: #FF99CC" data-color="FF99CC">&nbsp;</a></li><li><a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" style="background-color: #FFCC99" data-color="FFCC99">&nbsp;</a></li><li><a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" style="background-color: #FFFF99" data-color="FFFF99">&nbsp;</a></li><li><a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" style="background-color: #CCFFCC" data-color="CCFFCC">&nbsp;</a></li><li><a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" style="background-color: #CCFFFF" data-color="CCFFFF">&nbsp;</a></li><li><a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" style="background-color: #99CCFF" data-color="99CCFF">&nbsp;</a></li><li><a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" style="background-color: #CC99FF" data-color="CC99FF">&nbsp;</a></li><li><a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" style="background-color: #FFFFFF" data-color="FFFFFF">&nbsp;</a></li></ul></div></div></div>
                        </li>
                        <li id="more-menu" class="toolbar-item toolbar-dropdown">
                            <div class="aui-dd-parent">
                                <a id="rte-button-more" href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" class="toolbar-trigger aui-dd-trigger aui-button" data-tooltip="更多">


                                    <span class="icon aui-icon aui-icon-small aui-iconfont-editor-styles ">格式</span>


                                    <span class="icon aui-icon aui-icon-small aui-iconfont-dropdown "></span>
                                </a>
                                <div id="rte-button-more-menu" class="aui-dropdown grouped hidden">
                                    <div class="grouped-dropdown-item">
                                        <ul>
                                            <li class="dropdown-item more-menu-trigger" data-control-id="strikethrough" data-tooltip="删除线 (Ctrl+Shift+S)">
                                                <a id="rte-strikethrough" class="item-link" href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#">


                                                    <span class="icon aui-icon aui-icon-small aui-iconfont-check hidden"></span>
                                                    删除线
                                                </a>
                                            </li>
                                            <li class="dropdown-item more-menu-trigger" data-control-id="sub" data-tooltip="">
                                                <a id="rte-sub" class="item-link" href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#">


                                                    <span class="icon aui-icon aui-icon-small aui-iconfont-check hidden"></span>
                                                    下标
                                                </a>
                                            </li>
                                            <li class="dropdown-item more-menu-trigger" data-control-id="sup" data-tooltip="">
                                                <a id="rte-sup" class="item-link" href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#">


                                                    <span class="icon aui-icon aui-icon-small aui-iconfont-check hidden"></span>
                                                    上标
                                                </a>
                                            </li>
                                            <li class="dropdown-item more-menu-trigger" data-control-id="monospace" data-tooltip="用等宽字体格式化文本">
                                                <a id="rte-monospace" class="item-link" href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#">


                                                    <span class="icon aui-icon aui-icon-small aui-iconfont-check hidden"></span>
                                                    等宽
                                                </a>
                                            </li>

                                        </ul>
                                    </div>
                                    <div class="grouped-dropdown-item">
                                        <ul>
                                            <li class="dropdown-item more-menu-trigger no-icon" data-format="removeformat" data-tooltip="当前选中文本清除格式">
                                                <a id="rte-removeformat" class="item-link" href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#">
                                                    清除格式
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                        </li>
                    </ul>

                    <ul class="aui-buttons rte-toolbar-group-lists">

                        <li class="toolbar-item aui-button" id="rte-button-bullist" data-tooltip="无序列表 (Ctrl+Shift+B)">
                            <a class="toolbar-trigger" href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" data-control-id="bullist">


                                <span class="icon aui-icon aui-icon-small aui-iconfont-editor-list-bullet ">无序列表</span>
                            </a>
                        </li>

                        <li class="toolbar-item aui-button" id="rte-button-numlist" data-tooltip="有序列表 (Ctrl+Shift+N)">
                            <a class="toolbar-trigger" href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" data-control-id="numlist">


                                <span class="icon aui-icon aui-icon-small aui-iconfont-editor-list-number ">有序列表</span>
                            </a>
                        </li>
                    </ul>
                    <ul class="aui-buttons rte-toolbar-group-task-lists">

                        <li class="toolbar-item aui-button" id="rte-button-tasklist" data-tooltip="任务列表 ( )">
                            <a class="toolbar-trigger" href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" data-control-id="tasklist">


                                <span class="icon aui-icon aui-icon-small aui-iconfont-editor-task ">任务列表</span>
                            </a>
                        </li>
                    </ul>

                    <ul class="aui-buttons rte-toolbar-group-indentation">

                        <li class="toolbar-item aui-button" id="rte-button-outdent" data-tooltip="减小缩进">
                            <a class="toolbar-trigger" href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" data-control-id="outdent">


                                <span class="icon aui-icon aui-icon-small aui-iconfont-editor-outdent ">减小缩进</span>
                            </a>
                        </li>

                        <li class="toolbar-item aui-button" id="rte-button-indent" data-tooltip="增大缩进">
                            <a class="toolbar-trigger" href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" data-control-id="indent">


                                <span class="icon aui-icon aui-icon-small aui-iconfont-editor-indent ">增大缩进</span>
                            </a>
                        </li>
                    </ul>

                    <ul class="aui-buttons rte-toolbar-group-justification">

                        <li class="toolbar-item aui-button" id="rte-button-justifyleft" data-tooltip="左对齐">
                            <a class="toolbar-trigger" href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" data-control-id="justifyleft">


                                <span class="icon aui-icon aui-icon-small aui-iconfont-editor-align-left ">左对齐</span>
                            </a>
                        </li>

                        <li class="toolbar-item aui-button" id="rte-button-justifycenter" data-tooltip="居中">
                            <a class="toolbar-trigger" href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" data-control-id="justifycenter">


                                <span class="icon aui-icon aui-icon-small aui-iconfont-editor-align-center ">居中</span>
                            </a>
                        </li>

                        <li class="toolbar-item aui-button" id="rte-button-justifyright" data-tooltip="右对齐">
                            <a class="toolbar-trigger" href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" data-control-id="justifyright">


                                <span class="icon aui-icon aui-icon-small aui-iconfont-editor-align-right ">右对齐</span>
                            </a>
                        </li>
                    </ul>

                    <ul class="aui-buttons hidden" id="page-layout-2-group">
                        <li id="page-layout-2" class="toolbar-item" data-tooltip="页面布局">
                            <a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" class="aui-button toolbar-trigger" id="rte-button-pagelayout-2">


                                <span class="icon aui-icon aui-icon-small aui-iconfont-editor-layout ">页面布局</span>
                            </a>
                        </li>
                    </ul>


                    <ul class="aui-buttons rte-toolbar-group-files hidden"></ul>

                    <ul class="aui-buttons rte-toolbar-group-link no-separator">
                        <li class="toolbar-item" data-tooltip="插入链接 (Ctrl+K)">
                            <a id="rte-button-link" class="toolbar-trigger aui-button" href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" data-control-id="linkbrowserButton">


                                <span class="icon aui-icon aui-icon-small aui-iconfont-link "></span>
                                <span class="trigger-text">链接</span>
                            </a>
                        </li>
                    </ul>

                    <ul class="aui-buttons rte-toolbar-group-table no-separator">
                        <li class="toolbar-item toolbar-dropdown" id="insert-table-dropdown">
                            <div class="aui-dd-parent">
                                <a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" class="toolbar-trigger aui-dd-trigger aui-button" id="rte-button-insert-table" data-tooltip="插入表格">


                                    <span class="icon aui-icon aui-icon-small aui-iconfont-editor-table "></span>
                                    <span class="dropdown-text">表格</span>


                                    <span class="icon aui-icon aui-icon-small aui-iconfont-dropdown "></span>
                                </a>

                                <div id="table-picker-container" class="hidden aui-box-shadow">
                                    <div class="table-picker-box" data-tooltip="按住 SHIFT键，创建无表头表格 。">
                                        <div class="table-picker-background">
                                            <div class="picker picker-cell"></div>
                                            <div class="picker picker-heading heading"></div>
                                            <div class="picker picker-selected-cell"></div>
                                            <div class="picker picker-selected-heading heading"></div>
                                        </div>
                                        <p class="desc"></p>
                                    </div>
                                </div>
                            </div>
                        </li>
                    </ul>



                    <ul class="aui-buttons rte-toolbar-group-insert no-separator">
                        <li class="toolbar-item toolbar-dropdown" id="insert-menu">
                            <div class="aui-dd-parent">
                                <a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" class="toolbar-trigger aui-dd-trigger aui-button" id="rte-button-insert" data-tooltip="插入更多内容">


                                    <span class="icon aui-icon aui-icon-small aui-iconfont-add "></span>
                                    <span class="dropdown-text">插入</span>


                                    <span class="icon aui-icon aui-icon-small aui-iconfont-dropdown "></span>
                                </a>

                                <div id="insert-menu-options" class="aui-dropdown grouped hidden">
                                    <div class="grouped-dropdown-item">
                                        <span class="assistive">插入内容</span>
                                        <ul id="content-insert-list">


                                            <li class="dropdown-item content-image" data-command="mceConfimage" data-tooltip="插入文件和图片 (Ctrl+M)">
                                                <a id="rte-insert-image" class="item-link" href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#">


                                                    <span class="icon "></span>
                                                    文件和图片
                                                </a>
                                            </li>


                                            <li class="dropdown-item content-link" data-control-id="linkbrowserButton" data-tooltip="插入链接 (Ctrl+K)">
                                                <a id="rte-insert-link" class="item-link" href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#">


                                                    <span class="icon "></span>
                                                    链接
                                                </a>
                                            </li>


                                            <li class="dropdown-item content-symbol" data-command="confCharmap" data-tooltip="插入符号">
                                                <a id="rte-insert-symbol" class="item-link" href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#">


                                                    <span class="icon "></span>
                                                    符号
                                                </a>
                                            </li>


                                            <li class="dropdown-item content-emoticon" data-command="mceEmotion" data-tooltip="插入表情">
                                                <a id="rte-insert-emoticon" class="item-link" href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#">


                                                    <span class="icon "></span>
                                                    表情符号
                                                </a>
                                            </li>


                                            <li class="dropdown-item content-wikimarkup" data-command="InsertWikiMarkup" data-tooltip="插入Wiki标记 (Ctrl+Shift+D)">
                                                <a id="rte-insert-wikimarkup" class="item-link" href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#">


                                                    <span class="icon "></span>
                                                    Wiki标记
                                                </a>
                                            </li>


                                            <li class="dropdown-item content-hr" data-command="InsertHorizontalRule" data-tooltip="插入水平线(----)">
                                                <a id="rte-insert-hr" class="item-link" href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#">


                                                    <span class="icon "></span>
                                                    水平线
                                                </a>
                                            </li>


                                            <li class="dropdown-item content-tasklist" data-command="InsertInlineTaskListNoToggle" data-tooltip="插入任务列表 ( )">
                                                <a id="rte-insert-tasklist" class="item-link" href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#">


                                                    <span class="icon "></span>
                                                    任务列表
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                    <div class="grouped-dropdown-item">
                                        <span class="assistive">插入宏</span>
                                        <ul id="macro-insert-list">
                                            <li class="dropdown-item macro-insertmention-button" data-macro-name="insertmention-button" data-tooltip="插入&#39;用户提及&#39;宏">
                                                <a id="insertmention-button" class="item-link" href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#">


                                                    <span class="icon "></span>
                                                    用户提及
                                                </a>
                                            </li>
                                            <li class="dropdown-item macro-jiralink" data-macro-name="jiralink" data-tooltip="插入&#39;JIRA问题/过滤器&#39;宏">
                                                <a id="jiralink" class="item-link" href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#">


                                                    <span class="icon "></span>
                                                    JIRA问题/过滤器
                                                </a>
                                            </li>
                                            <li class="dropdown-item macro-info" data-macro-name="info" data-tooltip="插入&#39;信息&#39;宏">
                                                <a id="info" class="item-link" href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#">


                                                    <span class="icon "></span>
                                                    信息
                                                </a>
                                            </li>
                                            <li class="dropdown-item macro-drawio" data-macro-name="drawio" data-tooltip="插入&#39;Draw.io diagram&#39;宏">
                                                <a id="drawio" class="item-link" href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#">


                                                    <span class="icon "></span>
                                                    Draw.io diagram
                                                </a>
                                            </li>
                                            <li class="dropdown-item macro-status" data-macro-name="status" data-tooltip="插入&#39;状态&#39;宏">
                                                <a id="status" class="item-link" href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#">


                                                    <span class="icon "></span>
                                                    状态
                                                </a>
                                            </li>
                                            <li class="dropdown-item macro-gallery" data-macro-name="gallery" data-tooltip="插入&#39;画廊&#39;宏">
                                                <a id="gallery" class="item-link" href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#">


                                                    <span class="icon "></span>
                                                    画廊
                                                </a>
                                            </li>
                                            <li class="dropdown-item macro-toc" data-macro-name="toc" data-tooltip="插入&#39;目录&#39;宏">
                                                <a id="toc" class="item-link" href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#">


                                                    <span class="icon "></span>
                                                    目录
                                                </a>
                                            </li>
                                            <li class="dropdown-item macro-calendar" data-macro-name="calendar" data-tooltip="插入&#39;团队日程表&#39;宏">
                                                <a id="calendar" class="item-link" href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#">


                                                    <span class="icon "></span>
                                                    团队日程表
                                                </a>
                                            </li>


                                            <li class="dropdown-item content-macro" data-command="mceConfMacroBrowser" data-tooltip="打开宏浏览器 (Ctrl+Shift+A)">
                                                <a id="rte-insert-macro" class="item-link" href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#">


                                                    <span class="icon "></span>
                                                    其它宏
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </li>
                    </ul>

                    <ul class="aui-buttons rte-toolbar-group-page-layouts-section-types">
                        <li id="pagelayout-menu" class="toolbar-item toolbar-dropdown">
                            <div class="aui-dd-parent">
                                <a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" class="toolbar-trigger aui-dd-trigger aui-button" id="rte-button-pagelayout" data-tooltip="页面布局">


                                    <span class="icon aui-icon aui-icon-small aui-iconfont-layout pagelayout-default">页面布局</span>


                                    <span class="icon aui-icon aui-icon-small aui-iconfont-dropdown "></span>
                                </a>

                                <ul id="pagelayout-menu-options" class="aui-dropdown hidden">
                                    <li class="dropdown-item" data-tooltip="无布局">
                                        <a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" class="item-link" data-atlassian-layout="{&quot;name&quot;: &quot;pagelayout-none&quot;, &quot;columns&quot;: 0   }">


                                            <span class="icon aui-icon aui-icon-small aui-iconfont-check hidden"></span>


                                            <span class="icon aui-icon aui-icon-small aui-iconfont-layout pagelayout-none">无布局</span>
                                        </a>
                                    </li>
                                    <li class="dropdown-item" data-tooltip="两栏 (简单)">
                                        <a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" class="item-link" data-atlassian-layout="{&quot;name&quot;: &quot;pagelayout-two-simple&quot;, &quot;columns&quot;: [&quot;&quot;, &quot;&quot;]   }">


                                            <span class="icon aui-icon aui-icon-small aui-iconfont-check hidden"></span>


                                            <span class="icon aui-icon aui-icon-small aui-iconfont-layout pagelayout-two-simple">两栏 (简单)</span>
                                        </a>
                                    </li>
                                    <li class="dropdown-item" data-tooltip="两栏 (简单，左侧栏)">
                                        <a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" class="item-link" data-atlassian-layout="{&quot;name&quot;: &quot;pagelayout-two-simple-left&quot;, &quot;columns&quot;: [&quot;aside&quot;, &quot;large&quot;]   }">


                                            <span class="icon aui-icon aui-icon-small aui-iconfont-check hidden"></span>


                                            <span class="icon aui-icon aui-icon-small aui-iconfont-layout pagelayout-two-simple-left">两栏 (简单，左侧栏)</span>
                                        </a>
                                    </li>
                                    <li class="dropdown-item" data-tooltip="两栏 (简单，右侧栏)">
                                        <a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" class="item-link" data-atlassian-layout="{&quot;name&quot;: &quot;pagelayout-two-simple-right&quot;, &quot;columns&quot;: [&quot;large&quot;, &quot;aside&quot;]   }">


                                            <span class="icon aui-icon aui-icon-small aui-iconfont-check hidden"></span>


                                            <span class="icon aui-icon aui-icon-small aui-iconfont-layout pagelayout-two-simple-right">两栏 (简单，右侧栏)</span>
                                        </a>
                                    </li>
                                    <li class="dropdown-item" data-tooltip="三栏 (简单)">
                                        <a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" class="item-link" data-atlassian-layout="{&quot;name&quot;: &quot;pagelayout-three-simple&quot;, &quot;columns&quot;: [&quot;&quot;, &quot;&quot;, &quot;&quot;]   }">


                                            <span class="icon aui-icon aui-icon-small aui-iconfont-check hidden"></span>


                                            <span class="icon aui-icon aui-icon-small aui-iconfont-layout pagelayout-three-simple">三栏 (简单)</span>
                                        </a>
                                    </li>
                                    <li class="dropdown-item" data-tooltip="两栏">
                                        <a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" class="item-link" data-atlassian-layout="{&quot;name&quot;: &quot;pagelayout-two&quot;, &quot;columns&quot;: [&quot;&quot;, &quot;&quot;] , &quot;header&quot;: true  , &quot;footer&quot;:true  }">


                                            <span class="icon aui-icon aui-icon-small aui-iconfont-check hidden"></span>


                                            <span class="icon aui-icon aui-icon-small aui-iconfont-layout pagelayout-two">两栏</span>
                                        </a>
                                    </li>
                                    <li class="dropdown-item" data-tooltip="两栏 (左侧栏)">
                                        <a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" class="item-link" data-atlassian-layout="{&quot;name&quot;: &quot;pagelayout-two-left&quot;, &quot;columns&quot;: [&quot;aside&quot;, &quot;large&quot;] , &quot;header&quot;: true  , &quot;footer&quot;:true  }">


                                            <span class="icon aui-icon aui-icon-small aui-iconfont-check hidden"></span>


                                            <span class="icon aui-icon aui-icon-small aui-iconfont-layout pagelayout-two-left">两栏 (左侧栏)</span>
                                        </a>
                                    </li>
                                    <li class="dropdown-item" data-tooltip="两栏 (右侧栏)">
                                        <a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" class="item-link" data-atlassian-layout="{&quot;name&quot;: &quot;pagelayout-two-right&quot;, &quot;columns&quot;: [&quot;large&quot;, &quot;aside&quot;] , &quot;header&quot;: true  , &quot;footer&quot;:true  }">


                                            <span class="icon aui-icon aui-icon-small aui-iconfont-check hidden"></span>


                                            <span class="icon aui-icon aui-icon-small aui-iconfont-layout pagelayout-two-right">两栏 (右侧栏)</span>
                                        </a>
                                    </li>
                                    <li class="dropdown-item" data-tooltip="三栏">
                                        <a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" class="item-link" data-atlassian-layout="{&quot;name&quot;: &quot;pagelayout-three&quot;, &quot;columns&quot;: [&quot;&quot;, &quot;&quot;, &quotquot;&quot;] , &quot;header&quot;: true  , &quot;footer&quot;:true  }">


                                            <span class="icon aui-icon aui-icon-small aui-iconfont-check hidden"></span>


                                            <span class="icon aui-icon aui-icon-small aui-iconfont-layout pagelayout-three">三栏</span>
                                        </a>
                                    </li>
                                    <li class="dropdown-item" data-tooltip="三栏 (左边和右侧栏)">
                                        <a href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" class="item-link" data-atlassian-layout="{&quot;name&quot;: &quot;pagelayout-three-sidebars&quot;, &quot;columns&quot;: [&quot;sidebars&quot;, &quot;large&quot;, &quot;sidebars&quot;] , &quot;header&quot;: true  , &quot;footer&quot;:true  }">


                                            <span class="icon aui-icon aui-icon-small aui-iconfont-check hidden"></span>


                                            <span class="icon aui-icon aui-icon-small aui-iconfont-layout pagelayout-three-sidebars">三栏 (左边和右侧栏)</span>
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </li>
                    </ul>


                    <ul class="aui-buttons rte-toolbar-group-undo">

                        <li class="toolbar-item aui-button" id="rte-button-undo" data-tooltip="回退 (Ctrl+Z)">
                            <a class="toolbar-trigger" href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" data-control-id="undo">


                                <span class="icon aui-icon aui-icon-small aui-iconfont-undo ">回退</span>
                            </a>
                        </li>

                        <li class="toolbar-item aui-button" id="rte-button-redo" data-tooltip="重做 (Ctrl+Y)">
                            <a class="toolbar-trigger" href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" data-control-id="redo">


                                <span class="icon aui-icon aui-icon-small aui-iconfont-redo ">重做</span>
                            </a>
                        </li>
                    </ul>
                    <ul id="pluggable-status-container" class="aui-buttons rte-toolbar-pluggable-status no-separator">
                        <div id="pluggable-status"></div>
                    </ul>
                </div>                                                                                                <div id="draft-status" style="display:none"></div>
                <div class="aui-toolbar2-secondary">
                    <ul class="aui-buttons rte-toolbar-group-searchreplace">
                        <li class="toolbar-item aui-button" id="rte-button-searchreplace" data-tooltip="查找/替换">
                            <a class="toolbar-trigger" href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" data-control-id="searchreplace">


                                <span class="icon aui-icon aui-icon-small aui-iconfont-search ">查找/替换</span>
                            </a>
                        </li>
                    </ul>
                    <ul class="aui-buttons rte-toolbar-group-help">
                        <li class="toolbar-item aui-button" id="rte-button-help" data-tooltip="帮助">
                            <a class="toolbar-trigger" href="https://wiki.sankuai.com/pages/viewpage.action?pageId=1079095662#" data-control-id="help">


                                <span class="icon aui-icon aui-icon-small aui-iconfont-editor-help ">键盘快捷方式帮助</span>
                            </a>
                        </li>
                    </ul>
                </div>        </div>    </div>


        <div id="editor-notifications-container"><div id="all-messages"><div id="action-messages"></div></div></div><div id="editor-precursor"><div class="cell"><div class="aui-buttons aui-toolbar2"><button class="aui-button aui-button-subtle" type="button" data-tooltip="1 标签" id="rte-button-labels" data-explicit-restrictions="" data-inherited-restrictions=""><span class="icon aui-icon aui-icon-small aui-iconfont-devtools-tag"></span></button><button class="aui-button aui-button-subtle" type="button" data-tooltip="未限制" id="rte-button-restrictions" data-explicit-restrictions="false" data-inherited-restrictions="false"><span class="icon aui-icon aui-icon-small aui-iconfont-unlocked"></span></button></div><div id="content-title-div"><input type="text" name="title" id="content-title" tabindex="1" class="text pagetitle" autocomplete="off" value="CMS GC问题探究" placeholder="页面标题"></div></div></div>

        <div id="wysiwyg">
            <div id="rte" class="cell editor-default">
                <textarea id="wysiwygTextarea" name="wysiwygContent" class="hidden tinymce-editor"></textarea>
            </div>
        </div>
        <div id="editor-html-source-container" class="hidden">
            <textarea id="editor-html-source" class="monospaceInput"></textarea>
        </div>

        <div id="preview">
            <div id="previewArea" class="cell">
            </div>
        </div>

        <div id="savebar-container"><div id="rte-savebar" class="aui-toolbar aui-toolbar2"><div class="toolbar-split toolbar-split-row"><div class="toolbar-split toolbar-split-left"><div class="aui-buttons"></div></div><div class="toolbar-split toolbar-split-right"><div class="aui-buttons" id="rte-savebar-tinymce-plugin-point"></div><div class="aui-buttons"><span id="rte-spinner" class="toolbar-item ">&nbsp;</span></div><div class="aui-buttons toolbar-group-edit assistive"><button id="rte-button-edit" class="aui-button" title="返回编辑模式" type="button"><span class="trigger-text">编辑</span></button></div><div class="aui-buttons toolbar-group-preview"><button class="aui-button toolbar-item" id="rte-button-preview" title="预览" type="button"><span class="trigger-text">预览</span></button></div><div class="save-button-container"><button class="aui-button aui-button-primary" type="submit" id="rte-button-publish" name="confirm" value="Save" title="保存"><span class="trigger-text">保存</span></button></div><button class="toolbar-item-link aui-button aui-button-link" type="submit" id="rte-button-cancel" name="cancel" value="cancel"><span class="trigger-text">取消</span></button></div></div></div></div>

        <section role="dialog" id="discard-changes-dialog" class="aui-layer aui-dialog2 aui-dialog2-medium" aria-hidden="true">
            <!-- Dialog header -->
            <header class="aui-dialog2-header">
                <h2 class="aui-dialog2-header-main">Discard unpublished changes</h2>
            </header>
            <div class="aui-dialog2-content">
                <div>
                    <p>This will restore the editor to the last published version of this page. If anyone else has unpublished changes on the page, you'll be discarding those changes too.</p>
                </div>
                <div id="show-diff-body" style="display:none">
                    <div id="show-diff-dialog-content">
                        <div class="legend">
                            <span class="legend-title">标识: </span>
                            <span class="diff-html-added">该行被添加。</span>
                            <span class="diff-html-removed">该行被删除。</span>
                            <span class="diff-html-changed">格式已经改变。</span>
                        </div>
                        <hr>
                        <div id="show-diff-dialog-content-body"></div>
                    </div>
                </div>
            </div>
            <footer id="discard-warning-footer" class="aui-dialog2-footer">
                <div class="aui-dialog2-footer-actions">
                    <button id="discard-changes-dialog-submit-button" class="aui-button aui-button-primary">放弃</button>
                    <button id="discard-changes-dialog-show-diff-button" class="aui-button">See changes</button>
                    <button id="discard-changes-dialog-close-button" class="aui-button aui-button-link">取消</button>
                </div>
            </footer>

            <footer id="show-diff-footer" class="aui-dialog2-footer" style="display:none">
                <div class="aui-dialog2-footer-actions">
                    <button id="show-diff-dialog-submit-button" class="aui-button aui-button-primary">放弃</button>
                    <button id="show-diff-dialog-close-button" class="aui-button aui-button-link">取消</button>
                </div>
            </footer>
        </section>


    </div>



    <script type="text/x-template" title="dynamic-editor-metadata" id="dynamic-editor-metadata-template">
        <meta name="ajs-use-watch" content="true">
        <meta name="ajs-attachment-source-content-id" content="1079095662">
        <meta name="ajs-fallback-mode" content="false">
        <meta name="ajs-use-inline-tasks" content="true">
        <meta name="ajs-heartbeat" content="true">
        <meta name="ajs-action-locale" content="zh_CN">
        <meta name="ajs-editor-plugin-resource-prefix" content="/s/zh_CN/6441/3dfb154e647c41466ff19113f0197feded41ba10/5.10.2/_">
        <meta name="ajs-existing-draft-id" content="0">
        <meta name="ajs-user-watching-own-content" content="false">
        <meta name="ajs-new-page" content="false">
        <meta name="ajs-content-id" content="1079095662">
        <meta name="ajs-editor-mode" content="richtext">
        <meta name="ajs-form-name" content="inlinecommentform">
        <meta name="ajs-auto-start" content="false">
        <meta name="ajs-can-attach-files" content="true">
        <meta name="ajs-show-draft-message" content="false">
        <meta name="ajs-conf-revision" content="confluence$content$1079095662.186">
        <meta name="ajs-draft-id" content="0">
        <meta name="ajs-shared-drafts" content="false">
        <meta name="ajs-min-editor-height" content="150">
        <meta name="ajs-draft-share-id" content="">
        <meta name="ajs-content-type" content="page">
        <meta name="ajs-version-comment" content="">
        <meta name="ajs-draft-type" content="page">

        <meta name="ajs-synchrony-token" content="">
        <meta name="ajs-synchrony-service-uri" content="">
        <meta name="ajs-synchrony-resources-uri" content="">
        <meta name="ajs-synchrony-app-id" content="">
        <meta name="ajs-synchrony-dark-enabled" content="false">
        <meta name="ajs-synchrony-expiry" content="">

        <meta name="ajs-max-thumb-width" content="300">
        <meta name="ajs-max-thumb-height" content="300">
        <meta name="ajs-can-send-email" content="true">
        <meta name="ajs-is-dev-mode" content="false">
        <meta name="ajs-draft-save-interval" content="30000">
        <meta name="ajs-show-hidden-user-macros" content="false">
        <meta name="ajs-is-admin" content="false">
        <meta name="ajs-confluence.prefs.editor.disable.autocomplete" content="false">
        <meta name="ajs-confluence.prefs.editor.disable.autoformat" content="false">
        <meta name="ajs-heartbeat-interval" content="30000">

    </script>

    <script type="text/x-template" title="tableForm" id="table-form-template">
        <form id="tinymce-table-form" class="aui">
            <div class="field-group">
                <label for="rows">行</label>
                <input id="rows" name="rows" type="text" size="3" autocomplete="off" value="{0}">
            </div>
            <div class="field-group">
                <label for="cols">列</label>
                <input id="cols" name="cols" type="text" size="3" autocomplete="off" value="{1}">
            </div>
            <div class="field-group hidden">
                <input id="width" type="hidden" name="width" value="">
                <label for="width">宽</label>
            </div>
            <div class="group">
                <div class="checkbox">
                    <input id="table-heading-checkbox" class="checkbox" type="checkbox" name="heading" checked="checked" value="true">
                    <label for="table-heading-checkbox">首行设为表头</label>
                </div>
            </div>
            <div class="group hidden">
                <div class="checkbox">
                    <input id="table-equal-width-columns-checkbox" class="checkbox" type="checkbox" name="equal-width-columns" value="false">
                    <label for="table-equal-width-columns-checkbox">等宽列</label>
                </div>
            </div>
        </form>
    </script>
    <input type="hidden" name="draftId" value="0" id="draftId"><input type="hidden" name="originalVersion" value="90" id="originalVersion">
    <input type="hidden" name="syncRev" value="dummy-sync-rev" id="syncRev">    <input type="hidden" name="atl_token" value="0b04b3c37c0a1cbc9175d21a71d028f0d469a9f5">
</div><div id="content-hover-0" class="ajs-content-hover aui-box-shadow" style="display: none;"><div class="contents" style="width: 300px;"></div></div><div id="content-hover-1" class="ajs-content-hover aui-box-shadow" style="display: none;"><div class="contents" style="width: 300px;"></div></div></body></html>